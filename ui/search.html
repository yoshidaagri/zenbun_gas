<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèóÔ∏è „Éá„Ç∂„Ç§„É≥‰∫ãÂãôÊâÄ„Éâ„Ç≠„É•„É°„É≥„ÉàÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É† v2.0</title>
  
  <!-- Markdown parser library -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* „Ç´„Éº„Ç≠Ëâ≤„ÅÆ„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà */
    :root {
      --primary-khaki: #8B9A5B;
      --light-khaki: #A8B373;
      --pale-khaki: #C5D197;
      --cream-khaki: #F5F7F0;
      --dark-khaki: #6B7A47;
      --accent-khaki: #9CAD6B;
      --shadow-khaki: rgba(139, 154, 91, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      background: linear-gradient(135deg, var(--pale-khaki) 0%, var(--cream-khaki) 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .header {
      text-align: center;
      background: white;
      padding: 32px 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px var(--shadow-khaki);
      margin-bottom: 24px;
      border-left: 6px solid var(--primary-khaki);
    }
    
    .header h1 {
      margin: 0 0 16px 0;
      color: var(--primary-khaki);
      font-size: clamp(24px, 5vw, 32px);
      font-weight: 700;
    }
    
    .header p {
      color: #666;
      font-size: clamp(14px, 3vw, 16px);
      margin: 12px 0;
    }

    .version-badge {
      display: inline-block;
      background: var(--accent-khaki);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }
    
    .workflow {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin: 20px 0;
    }
    
    .workflow-step {
      background: var(--cream-khaki);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: clamp(12px, 2.5vw, 14px);
      color: var(--dark-khaki);
      font-weight: 500;
      border: 1px solid var(--pale-khaki);
    }
    
    .search-container {
      background: white;
      padding: clamp(20px, 4vw, 30px);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      margin-bottom: 24px;
    }
    
    .search-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .search-header h2 {
      color: var(--primary-khaki);
      margin: 0 0 12px 0;
      font-size: clamp(20px, 4vw, 24px);
    }
    
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    #searchInput {
      flex: 1;
      min-width: 200px;
      padding: 16px 18px;
      border: 2px solid var(--pale-khaki);
      border-radius: 12px;
      font-size: clamp(14px, 3vw, 16px);
      transition: all 0.3s ease;
      background: var(--cream-khaki);
    }
    
    #searchInput:focus {
      outline: none;
      border-color: var(--primary-khaki);
      box-shadow: 0 0 0 4px var(--shadow-khaki);
      background: white;
    }
    
    #searchBtn {
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: clamp(14px, 3vw, 16px);
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px var(--shadow-khaki);
      min-width: 80px;
      white-space: nowrap;
    }
    
    #searchBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-khaki);
    }
    
    #searchBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .search-examples {
      background: var(--cream-khaki);
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 16px;
      border: 1px solid var(--pale-khaki);
    }
    
    .search-examples h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: clamp(13px, 2.5vw, 14px);
    }
    
    .example-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .example-tag {
      background: white;
      color: var(--primary-khaki);
      padding: 6px 14px;
      border-radius: 16px;
      font-size: clamp(12px, 2.5vw, 13px);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--pale-khaki);
    }
    
    .example-tag:hover {
      background: var(--primary-khaki);
      color: white;
      transform: translateY(-1px);
    }
    
    .loading {
      text-align: center;
      padding: clamp(30px, 6vw, 50px);
      color: #666;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
    }
    
    .loading::before {
      content: '';
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--pale-khaki);
      border-top: 3px solid var(--primary-khaki);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    .full-screen-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(45, 45, 45, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }
    
    .full-screen-loading.hidden {
      display: none;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--primary-khaki);
      border-radius: 50%;
      animation: spin 1.2s linear infinite;
      margin-bottom: 24px;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .loading-subtext {
      font-size: 14px;
      opacity: 0.8;
      text-align: center;
      max-width: 300px;
      line-height: 1.5;
    }
    
    .loading-progress {
      margin-top: 20px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
    }
    
    .results-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      overflow: hidden;
    }
    
    .results-header {
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .results-header h3 {
      margin: 0;
      font-size: clamp(16px, 3.5vw, 20px);
    }
    
    .results-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: clamp(12px, 2.5vw, 14px);
      font-weight: 500;
    }
    
    .result-item {
      padding: 24px;
      border-bottom: 1px solid var(--pale-khaki);
      transition: background 0.2s ease;
    }
    
    .result-item:hover {
      background: var(--cream-khaki);
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .result-title {
      font-size: clamp(14px, 3vw, 16px);
      font-weight: 600;
      color: var(--dark-khaki);
      margin: 0;
      flex: 1;
      min-width: 200px;
    }
    
    .result-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .result-type {
      background: var(--accent-khaki);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: clamp(10px, 2vw, 12px);
      font-weight: 500;
    }
    
    .result-date {
      color: #888;
      font-size: clamp(10px, 2vw, 12px);
    }
    
    .result-summary {
      color: #555;
      font-size: clamp(13px, 2.8vw, 14px);
      margin: 12px 0;
      line-height: 1.5;
    }
    
    .result-preview {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: clamp(11px, 2.3vw, 12px);
      color: #666;
      margin: 12px 0;
      border-left: 4px solid var(--pale-khaki);
    }
    
    .result-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: clamp(12px, 2.5vw, 13px);
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }
    
    .btn-primary {
      background: var(--primary-khaki);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--dark-khaki);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--cream-khaki);
      color: var(--dark-khaki);
      border: 1px solid var(--pale-khaki);
    }
    
    .btn-secondary:hover {
      background: var(--pale-khaki);
    }
    
    .no-results {
      text-align: center;
      padding: clamp(40px, 8vw, 60px);
      color: #666;
    }
    
    .no-results h3 {
      color: var(--primary-khaki);
      margin-bottom: 16px;
      font-size: clamp(18px, 4vw, 22px);
    }
    
    .management-container {
      background: white;
      padding: clamp(20px, 4vw, 30px);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      margin-top: 24px;
    }
    
    .management-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .management-header h3 {
      color: var(--primary-khaki);
      margin: 0 0 12px 0;
      font-size: clamp(18px, 4vw, 20px);
    }
    
    .management-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .mgmt-btn {
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--light-khaki) 0%, var(--primary-khaki) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: clamp(13px, 3vw, 14px);
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .mgmt-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-khaki);
    }
    
    .mgmt-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-display {
      background: var(--cream-khaki);
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--pale-khaki);
      margin-top: 16px;
    }
    
    .status-display h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: clamp(14px, 3vw, 15px);
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--pale-khaki);
      font-size: clamp(12px, 2.5vw, 13px);
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-value {
      font-weight: 600;
      color: var(--primary-khaki);
    }

    /* AIÂàÜÊûê„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´ */
    .analysis-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      margin-top: 24px;
      overflow: hidden;
    }

    .analysis-header {
      background: linear-gradient(135deg, var(--accent-khaki) 0%, var(--primary-khaki) 100%);
      color: white;
      padding: 20px 24px;
      position: relative;
    }

    .analysis-header h3 {
      margin: 0 0 8px 0;
      font-size: clamp(18px, 4vw, 22px);
    }

    .analysis-header p {
      margin: 0;
      opacity: 0.9;
      font-size: clamp(13px, 3vw, 14px);
    }

    .close-analysis-btn {
      position: absolute;
      top: 20px;
      right: 24px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s ease;
    }

    .close-analysis-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .analysis-content {
      padding: 24px;
    }

    .analysis-file-info {
      background: var(--cream-khaki);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid var(--pale-khaki);
    }

    .analysis-file-info h4 {
      margin: 0 0 8px 0;
      color: var(--dark-khaki);
      font-size: clamp(14px, 3vw, 16px);
    }

    #analysisFileName {
      font-weight: 600;
      color: var(--primary-khaki);
      font-size: clamp(13px, 3vw, 15px);
    }

    .analysis-chat {
      background: var(--cream-khaki);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .chat-messages {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid var(--pale-khaki);
    }

    .chat-message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 12px;
    }

    .chat-message.assistant {
      background: #f3e5f5;
      border-left: 4px solid var(--accent-khaki);
    }

    .chat-message.user {
      background: #e3f2fd;
      border-left: 4px solid var(--primary-khaki);
      margin-left: 20px;
    }

    .message-header {
      font-weight: 600;
      font-size: 13px;
      color: var(--dark-khaki);
      margin-bottom: 6px;
    }

    .message-content {
      font-size: clamp(13px, 3vw, 14px);
      line-height: 1.5;
      color: #333;
    }
    
    /* Markdown „Çπ„Çø„Ç§„É™„É≥„Ç∞ */
    .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
      color: var(--primary-khaki);
      margin: 12px 0 8px 0;
      font-weight: 600;
    }
    
    .message-content h2 {
      font-size: 16px;
      border-bottom: 2px solid var(--pale-khaki);
      padding-bottom: 4px;
    }
    
    .message-content h3 {
      font-size: 14px;
    }
    
    .message-content ul, .message-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .message-content li {
      margin: 4px 0;
      line-height: 1.4;
    }
    
    .message-content strong {
      color: var(--dark-khaki);
      font-weight: 600;
    }
    
    .message-content em {
      color: var(--primary-khaki);
      font-style: italic;
    }
    
    .message-content code {
      background: var(--pale-khaki);
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    
    .message-content pre {
      background: var(--pale-khaki);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }
    
    .message-content blockquote {
      border-left: 4px solid var(--primary-khaki);
      margin: 8px 0;
      padding: 8px 0 8px 12px;
      background: rgba(139, 154, 91, 0.05);
      font-style: italic;
    }
    
    .message-content p {
      margin: 8px 0;
    }
    
    .message-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 8px 0;
      font-size: 13px;
    }
    
    .message-content th, .message-content td {
      border: 1px solid var(--pale-khaki);
      padding: 6px 8px;
      text-align: left;
    }
    
    .message-content th {
      background: var(--pale-khaki);
      font-weight: 600;
      color: var(--dark-khaki);
    }

    .question-examples {
      margin-bottom: 16px;
    }

    .question-examples h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: clamp(13px, 3vw, 14px);
    }

    .example-questions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .example-question {
      background: white;
      color: var(--primary-khaki);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: clamp(11px, 2.5vw, 12px);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--pale-khaki);
    }

    .example-question:hover {
      background: var(--primary-khaki);
      color: white;
      transform: translateY(-1px);
    }

    .input-area {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    #analysisQuestionInput {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--pale-khaki);
      border-radius: 8px;
      font-size: clamp(13px, 3vw, 14px);
      resize: vertical;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }

    #analysisQuestionInput:focus {
      outline: none;
      border-color: var(--primary-khaki);
      box-shadow: 0 0 0 4px var(--shadow-khaki);
    }

    #analysisAskBtn {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(13px, 3vw, 14px);
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    #analysisAskBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow-khaki);
    }

    #analysisAskBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .analysis-status {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-radius: 8px;
      text-align: center;
      font-size: clamp(12px, 2.5vw, 13px);
      color: var(--dark-khaki);
      border: 1px solid var(--pale-khaki);
    }
    
    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 768px) {
      .search-box {
        flex-direction: column;
      }
      
      #searchBtn {
        width: 100%;
      }
      
      .result-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .result-actions {
        justify-content: center;
      }
      
      .management-buttons {
        grid-template-columns: 1fr;
      }
    }
    
    /* „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* „Éï„Ç©„Éº„Ç´„ÇπÁÆ°ÁêÜ */
    .focusable:focus {
      outline: 2px solid var(--primary-khaki);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div class="full-screen-loading hidden" id="fullScreenLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">AIËß£ÊûêÂá¶ÁêÜ‰∏≠...</div>
    <div class="loading-subtext" id="loadingSubtext">„Éï„Ç°„Ç§„É´„ÇíGemini„ÅßËß£Êûê„Åó„ÄÅAIÂõûÁ≠î„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô</div>
    <div class="loading-progress" id="loadingProgress">Ê∫ñÂÇô‰∏≠...</div>
  </div>

  <div class="header">
    <h1>üèóÔ∏è „Éá„Ç∂„Ç§„É≥‰∫ãÂãôÊâÄ„Éâ„Ç≠„É•„É°„É≥„ÉàÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†</h1>
    <p>googledrive„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÇíAI„ÅåË¶ÅÁ¥Ñ„Åó„Å¶Ê§úÁ¥¢ÂèØËÉΩ„Å´„Åó„Åæ„Åô</p>
    <p>„ÄåAÊ°à‰ª∂„ÅÆÂõ≥Èù¢„Äç„ÅÆ„Çà„ÅÜ„Å™ÊõñÊòß„Å™‰æùÈ†º„Å´„ÇÇAI„ÅåÂØæÂøú„Åó„Åæ„Åô</p>
    
    <div class="workflow">
      <span class="workflow-step">üìÅ Google Drive</span>
      <span class="workflow-step">ü§ñ Gemini AIË¶ÅÁ¥Ñ</span>
      <span class="workflow-step">üìä Ê§úÁ¥¢„ÉªË°®Á§∫</span>
    </div>
  </div>

  <div class="search-container">
    <div class="search-header">
      <h2>üîç „Éâ„Ç≠„É•„É°„É≥„ÉàÊ§úÁ¥¢</h2>
      <p>„Éï„Ç°„Ç§„É´Âêç„ÄÅÂÜÖÂÆπ„ÄÅAIË¶ÅÁ¥Ñ„Åã„ÇâÊ®™Êñ≠Ê§úÁ¥¢„Åß„Åç„Åæ„Åô</p>
    </div>
    
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="‰æã: Ë®≠Ë®à, Âπ≥Èù¢Âõ≥, „Ç´„Éï„ÇßË®≠Ë®à..." 
             onkeydown="if(event.key==='Enter')performSearch()">
      <button id="searchBtn" onclick="performSearch()">Ê§úÁ¥¢</button>
    </div>
    
    <div class="search-examples">
      <h4>üéØ Ê§úÁ¥¢‰æã („ÇØ„É™„ÉÉ„ÇØ„ÅßÊ§úÁ¥¢)</h4>
      <div class="example-tags">
        <span class="example-tag" onclick="searchExample('')">ÂÖ®„Éá„Éº„ÇøË°®Á§∫</span>
        <span class="example-tag" onclick="searchExample('Ë®≠Ë®à')">Ë®≠Ë®à</span>
        <span class="example-tag" onclick="searchExample('Âπ≥Èù¢Âõ≥')">Âπ≥Èù¢Âõ≥</span>
        <span class="example-tag" onclick="searchExample('„Ç´„Éï„Çß')">„Ç´„Éï„Çß</span>
        <span class="example-tag" onclick="searchExample('‰ΩèÂÆÖ')">‰ΩèÂÆÖ</span>
        <span class="example-tag" onclick="searchExample('„ÉÜ„É©„Çπ')">„ÉÜ„É©„Çπ</span>
        <span class="example-tag" onclick="searchExample('2Èöé')">2Èöé</span>
      </div>
    </div>
  </div>

  <div id="results"></div>

  <!-- AIÂàÜÊûê„Ç®„É™„Ç¢ -->
  <div class="analysis-container" id="analysisContainer" style="display: none;">
    <div class="analysis-header">
      <h3>üî¨ AI „Éï„Ç°„Ç§„É´ÂàÜÊûê„Éª„ÉÅ„É£„ÉÉ„Éà</h3>
      <p>ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíAI„ÅßË©≥Á¥∞ÂàÜÊûê„Åó„ÄÅË≥™ÂïèÂøúÁ≠î„Åß„Åç„Åæ„Åô</p>
      <button class="close-analysis-btn" onclick="closeAnalysis()">‚úï ÂàÜÊûê„Ç®„É™„Ç¢„ÇíÈñâ„Åò„Çã</button>
    </div>
    
    <div class="analysis-content">
      <!-- „Éï„Ç°„Ç§„É´ÊÉÖÂ†±Ë°®Á§∫ -->
      <div class="analysis-file-info" id="analysisFileInfo">
        <h4>üìÑ Ëß£ÊûêÂØæË±°„Éï„Ç°„Ç§„É´</h4>
        <div id="analysisFileName">„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
      </div>
      
      <!-- „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
      <div class="analysis-chat">
        <div class="chat-messages" id="analysisChatMessages">
          <div class="chat-message assistant">
            <div class="message-header">ü§ñ Gemini AI</div>
            <div class="message-content">
              „Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„ÇíÈñãÂßã„Åó„Åæ„ÅôÔºÅ<br>
              **Á∞°ÊΩî„Å™ÂõûÁ≠î**„Åß„ÅäÁ≠î„Åà„Åó„Åæ„Åô„ÅÆ„Åß„ÄÅÊ∞óËªΩ„Å´Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
              üìù „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥ÂΩ¢Âºè„ÅßË¶ã„ÇÑ„Åô„ÅèË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
            </div>
          </div>
        </div>
        
        <!-- Ë≥™ÂïèÂÖ•Âäõ„Ç®„É™„Ç¢ -->
        <div class="question-input">
          <div class="question-examples">
            <h4>üí° Ë≥™Âïè‰æãÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÖ•ÂäõÔºâ</h4>
            <div class="example-questions">
              <span class="example-question" onclick="setAnalysisQuestion('„Åì„ÅÆÂõ≥Èù¢„ÅÆÊ¶ÇË¶Å„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ')">Âõ≥Èù¢„ÅÆÊ¶ÇË¶Å</span>
              <span class="example-question" onclick="setAnalysisQuestion('‰∏ªË¶Å„Å™ÂØ∏Ê≥ï„Å®ÊßãÈÄ†„ÇíÊïô„Åà„Å¶')">ÂØ∏Ê≥ï„ÉªÊßãÈÄ†</span>
              <span class="example-question" onclick="setAnalysisQuestion('„Éá„Ç∂„Ç§„É≥„ÅÆÁâπÂæ¥„ÇíÁ∞°ÊΩî„Å´')">„Éá„Ç∂„Ç§„É≥ÁâπÂæ¥</span>
              <span class="example-question" onclick="setAnalysisQuestion('ÊîπÂñÑÁÇπ„Çí3„Å§Êïô„Åà„Å¶')">ÊîπÂñÑÊèêÊ°à</span>
              <span class="example-question" onclick="setAnalysisQuestion('Áî®ÈÄî„Å®Ê©üËÉΩ„ÇíÊïô„Åà„Å¶')">Áî®ÈÄî„ÉªÊ©üËÉΩ</span>
              <span class="example-question" onclick="setAnalysisQuestion('Ê≥®ÊÑè„Åô„Åπ„ÅçÁÇπ„ÅØÔºü')">Ê≥®ÊÑèÁÇπ</span>
            </div>
          </div>
          
          <div class="input-area">
            <textarea id="analysisQuestionInput" placeholder="„Éï„Ç°„Ç§„É´„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." rows="3"></textarea>
            <button id="analysisAskBtn" onclick="askAnalysisQuestion()">Ë≥™Âïè„Åô„Çã</button>
          </div>
        </div>
      </div>
      
      <!-- „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ -->
      <div class="analysis-status" id="analysisStatus">
        Ê∫ñÂÇôÂÆå‰∫Ü
      </div>
    </div>
  </div>

  <div class="management-container">
    <div class="management-header">
      <h3>‚öôÔ∏è „Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜ</h3>
      <p>„Éâ„Ç≠„É•„É°„É≥„ÉàËß£Êûê„ÇÑ„Ç∑„Çπ„ÉÜ„É†„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åß„Åç„Åæ„Åô</p>
    </div>
    
    <div class="management-buttons">
      <button class="mgmt-btn" onclick="analyzeNewDocuments()">üìä Êñ∞Ë¶è„Éâ„Ç≠„É•„É°„É≥„ÉàËß£Êûê</button>
      <button class="mgmt-btn" onclick="showAllDocuments()">üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàË°®Á§∫</button>
      <button class="mgmt-btn" onclick="testGeminiConnection()">ü§ñ GeminiÊé•Á∂ö„ÉÜ„Çπ„Éà</button>
      <button class="mgmt-btn" onclick="runDebugTests()">üîß Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞</button>
      <button class="mgmt-btn" onclick="testSearchStats()">üìä Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„Éà</button>
      <button class="mgmt-btn" onclick="testAnalysisConnection()">üß™ AIÂàÜÊûêÊé•Á∂ö„ÉÜ„Çπ„Éà</button>
      <button class="mgmt-btn" onclick="testAnalysisManagerDetails()">üîç AnalysisManagerË©≥Á¥∞„ÉÜ„Çπ„Éà</button>
      <button class="mgmt-btn" onclick="testCreateAnalysisSessionUnit()">‚öôÔ∏è „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂçò‰Ωì„ÉÜ„Çπ„Éà</button>
      <button class="mgmt-btn" onclick="checkSystemHealth()">ü©∫ „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ</button>
    </div>

    <div class="status-display" id="systemStatus">
      <h4>üìä „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h4>
      <div class="status-item">
        <span>„Ç∑„Çπ„ÉÜ„É†„Éê„Éº„Ç∏„Éß„É≥</span>
        <span class="status-value">„É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞Áâà v2.0</span>
      </div>
      <div class="status-item">
        <span>ÊúÄÁµÇÊõ¥Êñ∞</span>
        <span class="status-value" id="lastUpdate">-</span>
      </div>
      <div class="status-item">
        <span>„Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖã</span>
        <span class="status-value" id="dbStatus">Á¢∫Ë™ç‰∏≠...</span>
      </div>
    </div>
  </div>

  <script>
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let isSearching = false;
    let currentSystemInfo = null;

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
    window.addEventListener('load', function() {
      console.log('üöÄ „Éá„Ç∂„Ç§„É≥‰∫ãÂãôÊâÄÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É† v2.0 Ëµ∑Âãï');
      updateSystemStatus();
      
      // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
      document.getElementById('searchInput').focus();
    });

    // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊõ¥Êñ∞
    async function updateSystemStatus() {
      try {
        const info = await google.script.run
          .withSuccessHandler(updateStatusDisplay)
          .withFailureHandler(handleError)
          .getSystemInfo();
      } catch (error) {
        console.error('„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÂèñÂæó„Ç®„É©„Éº:', error);
        document.getElementById('dbStatus').textContent = '„Ç®„É©„Éº';
      }
    }

    function updateStatusDisplay(info) {
      currentSystemInfo = info;
      document.getElementById('lastUpdate').textContent = info.timestamp || '-';
      
      if (info.config) {
        const configStatus = Object.values(info.config).every(Boolean) ? 'Ê≠£Â∏∏' : 'Ë®≠ÂÆö‰∏çÂÆåÂÖ®';
        document.getElementById('dbStatus').textContent = configStatus;
      }
    }

    // Ê§úÁ¥¢Ê©üËÉΩ
    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      
      if (isSearching) {
        console.log('‚ö†Ô∏è Ê§úÁ¥¢‰∏≠„ÅÆ„Åü„ÇÅÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó');
        return;
      }
      
      console.log(`üîç Ê§úÁ¥¢ÈñãÂßã: "${query}"`);
      isSearching = true;
      
      const searchBtn = document.getElementById('searchBtn');
      const originalText = searchBtn.textContent;
      
      try {
        // UIÊõ¥Êñ∞
        searchBtn.disabled = true;
        searchBtn.textContent = 'Ê§úÁ¥¢‰∏≠...';
        document.getElementById('results').innerHTML = '<div class="loading">Ê§úÁ¥¢‰∏≠„Åß„Åô...</div>';
        
        // Ê§úÁ¥¢ÂÆüË°å
        const results = await google.script.run
          .withSuccessHandler(displaySearchResults)
          .withFailureHandler(handleSearchError)
          .searchDocuments(query);
          
      } catch (error) {
        console.error('Ê§úÁ¥¢„Ç®„É©„Éº:', error);
        handleSearchError(error);
      } finally {
        // UIÂæ©ÂÖÉ
        searchBtn.disabled = false;
        searchBtn.textContent = originalText;
        isSearching = false;
      }
    }

    function displaySearchResults(results) {
      console.log('üìä Ê§úÁ¥¢ÁµêÊûúÂèó‰ø°:', results);
      
      const resultsDiv = document.getElementById('results');
      
      if (!results || !Array.isArray(results) || results.length === 0) {
        resultsDiv.innerHTML = `
          <div class="results-container">
            <div class="no-results">
              <h3>üì≠ Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</h3>
              <p>Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
              <p>„Åæ„Åü„ÅØ„ÄåÂÖ®„Éá„Éº„ÇøË°®Á§∫„Äç„Éú„Çø„É≥„ÅßÂÖ®‰ª∂„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô</p>
            </div>
          </div>
        `;
        return;
      }
      
      const resultsHtml = `
        <div class="results-container">
          <div class="results-header">
            <h3>üìã Ê§úÁ¥¢ÁµêÊûú</h3>
            <div class="results-count">${results.length}‰ª∂Ë¶ã„Å§„Åã„Çä„Åæ„Åó„Åü</div>
          </div>
          ${results.map(result => createResultItemHtml(result)).join('')}
        </div>
      `;
      
      resultsDiv.innerHTML = resultsHtml;
      
      // ÁµêÊûú„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function createResultItemHtml(result) {
      const fileName = result.fileName || '‰∏çÊòé„Å™„Éï„Ç°„Ç§„É´';
      const aiSummary = result.aiSummary || 'Ë¶ÅÁ¥Ñ„Å™„Åó';
      const extractedText = result.extractedText || '';
      const fileType = result.fileType || '‰∏çÊòé';
      const updateDate = result.updateDate || '-';
      const viewUrl = result.viewUrl || '#';
      
      return `
        <div class="result-item">
          <div class="result-header">
            <h4 class="result-title">üìÑ ${fileName}</h4>
            <div class="result-meta">
              <span class="result-type">${fileType}</span>
              <span class="result-date">${updateDate}</span>
            </div>
          </div>
          
          <div class="result-summary">${aiSummary}</div>
          
          ${extractedText ? `<div class="result-preview">üìù ÊäΩÂá∫„ÉÜ„Ç≠„Çπ„Éà: ${extractedText}</div>` : ''}
          
          <div class="result-actions">
            <a href="${viewUrl}" target="_blank" class="action-btn btn-primary">üìÅ „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè</a>
            <button class="action-btn btn-secondary" onclick="copyToClipboard('${fileName}')">üìã „Éï„Ç°„Ç§„É´Âêç„Ç≥„Éî„Éº</button>
            <button class="action-btn btn-primary" onclick="analyzeFile('${result.fileId}', '${fileName}')">üî¨ AIËß£Êûê</button>
          </div>
        </div>
      `;
    }

    function handleSearchError(error) {
      console.error('Ê§úÁ¥¢„Ç®„É©„Éº:', error);
      document.getElementById('results').innerHTML = `
        <div class="results-container">
          <div class="no-results">
            <h3>‚ùå Ê§úÁ¥¢„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h3>
            <p>„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <p>„Ç®„É©„ÉºË©≥Á¥∞: ${error.message || error}</p>
          </div>
        </div>
      `;
    }

    // Ê§úÁ¥¢‰æãÂÆüË°å
    function searchExample(query) {
      document.getElementById('searchInput').value = query;
      performSearch();
    }

    // ÁÆ°ÁêÜÊ©üËÉΩ
    async function analyzeNewDocuments() {
      if (confirm('Êñ∞Ë¶è„Éâ„Ç≠„É•„É°„É≥„ÉàËß£Êûê„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\n‚Äª Âá¶ÁêÜ„Å´ÊôÇÈñì„Åå„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô')) {
        try {
          showLoadingStatus('üìä Êñ∞Ë¶è„Éâ„Ç≠„É•„É°„É≥„ÉàËß£Êûê‰∏≠...');
          
          const result = await google.script.run
            .withSuccessHandler(handleAnalysisResult)
            .withFailureHandler(handleError)
            .analyzeDocuments();
            
        } catch (error) {
          handleError(error);
        }
      }
    }

    function handleAnalysisResult(result) {
      hideLoadingStatus();
      
      if (result.success) {
        alert(`‚úÖ Ëß£ÊûêÂÆå‰∫Ü\nÂá¶ÁêÜ: ${result.processed}‰ª∂\n„Çπ„Ç≠„ÉÉ„Éó: ${result.skipped}‰ª∂\n„Ç®„É©„Éº: ${result.errors}‰ª∂`);
        updateSystemStatus();
      } else {
        alert(`‚ùå Ëß£Êûê„Ç®„É©„Éº\n${result.error}`);
      }
    }

    async function showAllDocuments() {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              window.open(result.url, '_blank');
            } else {
              alert(`‚ùå „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàURLÂèñÂæó„Ç®„É©„Éº\n${result ? result.error : '‰∏çÊòé„Å™„Ç®„É©„Éº'}`);
            }
          })
          .withFailureHandler(function(error) {
            console.error('GASÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
            alert(`‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü\n${error.message || error}`);
          })
          .getSpreadsheetUrl();
      } catch (error) {
        console.error('Èñ¢Êï∞ÂÆüË°å„Ç®„É©„Éº:', error);
        alert(`‚ùå ÂÆüË°å„Ç®„É©„Éº\n${error.message || error}`);
      }
    }

    async function testGeminiConnection() {
      try {
        showLoadingStatus('ü§ñ GeminiÊé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...');
        
        await google.script.run
          .withSuccessHandler(() => {
            hideLoadingStatus();
            alert('‚úÖ GeminiÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü');
          })
          .withFailureHandler((error) => {
            hideLoadingStatus();
            alert(`‚ùå GeminiÊé•Á∂ö„ÉÜ„Çπ„ÉàÂ§±Êïó\n${error.message || error}`);
          })
          .testGemini();
          
      } catch (error) {
        hideLoadingStatus();
        handleError(error);
      }
    }

    async function runDebugTests() {
      if (confirm('Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\n‚Äª „Ç≥„É≥„ÇΩ„Éº„É´„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ')) {
        try {
          showLoadingStatus('üîß „Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„ÉàÂÆüË°å‰∏≠...');
          
          await google.script.run
            .withSuccessHandler(() => {
              hideLoadingStatus();
              alert('‚úÖ „Éá„Éê„ÉÉ„Ç∞„ÉÜ„Çπ„ÉàÂÆå‰∫Ü\n„Ç≥„É≥„ÇΩ„Éº„É´„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            })
            .withFailureHandler(handleError)
            .runStepByStepTest();
            
        } catch (error) {
          hideLoadingStatus();
          handleError(error);
        }
      }
    }

    function checkSystemHealth() {
      try {
        showLoadingStatus('ü©∫ „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...');
        
        google.script.run
          .withSuccessHandler(displayHealthResult)
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            handleError(error);
          })
          .performHealthCheck();
          
      } catch (error) {
        hideLoadingStatus();
        handleError(error);
      }
    }

    // AIÂàÜÊûêÊé•Á∂ö„ÉÜ„Çπ„Éà
    function testAnalysisConnection() {
      try {
        showLoadingStatus('üß™ AIÂàÜÊûêÊé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...');
        console.log('üß™ AIÂàÜÊûêÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñãÂßã');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('üß™ „ÉÜ„Çπ„ÉàÁµêÊûú:', result);
            
            if (result === null || result === undefined) {
              alert('‚ùå „ÉÜ„Çπ„ÉàÂ§±Êïó: GASÈñ¢Êï∞„Åånull„ÇíËøî„Åó„Åæ„Åó„Åü\n\nGAS„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } else if (result.success) {
              alert(`‚úÖ AIÂàÜÊûêÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅ\n\nË©≥Á¥∞:\n- „É°„ÉÉ„Çª„Éº„Ç∏: ${result.message}\n- ÊôÇÂàª: ${result.timestamp}\n- „Éê„Éº„Ç∏„Éß„É≥: ${result.gasVersion}`);
            } else {
              alert(`‚ùå „ÉÜ„Çπ„ÉàÂ§±Êïó: ${result.error}\n\nÊôÇÂàª: ${result.timestamp}`);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('‚ùå „ÉÜ„Çπ„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
            alert(`‚ùå „ÉÜ„Çπ„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº\n\n${error.message || error}`);
          })
          .testAnalysisConnection('„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Åã„Çâ„ÅÆ„ÉÜ„Çπ„Éà');
          
      } catch (error) {
        hideLoadingStatus();
        console.error('‚ùå „ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ:', error);
        alert(`‚ùå „ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ\n\n${error.message}`);
      }
    }

    // AnalysisManagerË©≥Á¥∞„ÉÜ„Çπ„Éà
    function testAnalysisManagerDetails() {
      try {
        console.log('üîç AnalysisManagerË©≥Á¥∞„ÉÜ„Çπ„ÉàÈñãÂßã');
        showLoadingStatus('üîç AnalysisManagerË©≥Á¥∞„ÉÜ„Çπ„Éà‰∏≠...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('üîç Ë©≥Á¥∞„ÉÜ„Çπ„ÉàÁµêÊûú:', result);
            
            if (result === null || result === undefined) {
              alert('‚ùå „ÉÜ„Çπ„ÉàÂ§±Êïó: GASÈñ¢Êï∞„Åånull„ÇíËøî„Åó„Åæ„Åó„Åü\n\nGAS„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } else if (result.error) {
              alert(`‚ùå „ÉÜ„Çπ„ÉàÂÆüË°å„Ç®„É©„Éº: ${result.error}\n\n${result.summary}`);
            } else {
              let message = `üîç AnalysisManagerË©≥Á¥∞„ÉÜ„Çπ„ÉàÁµêÊûú\n\n`;
              message += `„Çµ„Éû„É™„Éº: ${result.summary}\n\n`;
              
              if (result.tests) {
                message += `üìã „ÉÜ„Çπ„ÉàÁµêÊûú:\n`;
                message += `- AnalysisManagerÂ≠òÂú®: ${result.tests.analysisManagerExists ? '‚úÖ' : '‚ùå'}\n`;
                message += `- createMethodExists: ${result.tests.createMethodExists ? '‚úÖ' : '‚ùå'}\n`;
                
                if (result.tests.dependencies) {
                  message += `\nüîß ‰æùÂ≠ò„É¢„Ç∏„É•„Éº„É´:\n`;
                  Object.entries(result.tests.dependencies).forEach(([dep, exists]) => {
                    message += `- ${dep}: ${exists ? '‚úÖ' : '‚ùå'}\n`;
                  });
                }
                
                if (result.tests.sessionCreation) {
                  message += `\nüìä „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„ÉÜ„Çπ„Éà:\n`;
                  message += `- ÊàêÂäü: ${result.tests.sessionCreation.success ? '‚úÖ' : '‚ùå'}\n`;
                  message += `- sessionId: ${result.tests.sessionCreation.hasSessionId ? '‚úÖ' : '‚ùå'}\n`;
                  message += `- fileIds: ${result.tests.sessionCreation.hasFileIds ? '‚úÖ' : '‚ùå'}\n`;
                }
              }
              
              if (result.errors && result.errors.length > 0) {
                message += `\n‚ùå „Ç®„É©„Éº:\n${result.errors.join('\n')}`;
              }
              
              alert(message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('‚ùå Ë©≥Á¥∞„ÉÜ„Çπ„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
            alert(`‚ùå Ë©≥Á¥∞„ÉÜ„Çπ„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº\n\n${error.message || error}`);
          })
          .testAnalysisManagerDetails();
          
      } catch (error) {
        hideLoadingStatus();
        console.error('‚ùå Ë©≥Á¥∞„ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ:', error);
        alert(`‚ùå Ë©≥Á¥∞„ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ\n\n${error.message}`);
      }
    }

    // Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÈñ¢Êï∞
    function testSearchStats() {
      try {
        console.log('üìä Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÈñãÂßã');
        showLoadingStatus('üìä Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„Éà‰∏≠...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('üìä Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÁµêÊûú:', result);
            
            if (result && result.success) {
              alert(`‚úÖ Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅ\n\n` +
                   `„ÉÜ„Çπ„Éà„ÇØ„Ç®„É™: "${result.testQuery}"\n` +
                   `Ê§úÁ¥¢ÁµêÊûúÊï∞: ${result.searchResults}‰ª∂\n` +
                   `„É°„ÉÉ„Çª„Éº„Ç∏: ${result.message}\n\n` +
                   `GAS„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶Áµ±Ë®àË®òÈå≤„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            } else {
              alert(`‚ùå Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÂ§±Êïó\n\n„Ç®„É©„Éº: ${result ? result.error : '‰∏çÊòé„Å™„Ç®„É©„Éº'}`);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('‚ùå Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
            alert(`‚ùå Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„Éà„Ç®„É©„Éº\n\n${error.message || error}`);
          })
          .testSearchWithStats('Áµ±Ë®à„ÉÜ„Çπ„ÉàÊ§úÁ¥¢');
          
      } catch (error) {
        hideLoadingStatus();
        console.error('‚ùå Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ:', error);
        alert(`‚ùå Ê§úÁ¥¢Áµ±Ë®à„ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ\n\n${error.message}`);
      }
    }

    // „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂçò‰Ωì„ÉÜ„Çπ„Éà
    function testCreateAnalysisSessionUnit() {
      try {
        console.log('‚öôÔ∏è „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂçò‰Ωì„ÉÜ„Çπ„ÉàÈñãÂßã');
        showLoadingStatus('‚öôÔ∏è „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂçò‰Ωì„ÉÜ„Çπ„Éà‰∏≠...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('‚öôÔ∏è Âçò‰Ωì„ÉÜ„Çπ„ÉàÁµêÊûú:', result);
            
            if (result === null || result === undefined) {
              alert('‚ùå „ÉÜ„Çπ„ÉàÂ§±Êïó: GASÈñ¢Êï∞„Åånull„ÇíËøî„Åó„Åæ„Åó„Åü\n\nGAS„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } else if (result.error) {
              alert(`‚ùå „ÉÜ„Çπ„ÉàÂÆüË°å„Ç®„É©„Éº: ${result.error}\n\n${result.summary}`);
            } else {
              let message = `‚öôÔ∏è „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂçò‰Ωì„ÉÜ„Çπ„ÉàÁµêÊûú\n\n`;
              message += `„Çµ„Éû„É™„Éº: ${result.summary}\n\n`;
              
              if (result.results) {
                message += `üìã „ÉÜ„Çπ„Éà„Ç±„Éº„ÇπÁµêÊûú:\n`;
                result.results.forEach((testCase, index) => {
                  message += `\n${index + 1}. ${testCase.case}:\n`;
                  
                  // „Ç®„É©„Éº„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Ë°®Á§∫
                  if (testCase.case.includes('„Ç®„É©„Éº„ÉÜ„Çπ„Éà')) {
                    message += `   „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞: ${testCase.success ? '‚úÖ Ê≠£Â∏∏' : '‚ùå Áï∞Â∏∏'}\n`;
                    if (testCase.errorHandling) {
                      message += `   Âà§ÂÆö: ${testCase.errorHandling}\n`;
                    }
                    if (testCase.error) {
                      message += `   „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏: ${testCase.error}\n`;
                    }
                  } else {
                    // ÈÄöÂ∏∏„ÅÆ„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ
                    message += `   ÊàêÂäü: ${testCase.success ? '‚úÖ' : '‚ùå'}\n`;
                    
                    if (testCase.hasSessionId !== undefined) {
                      message += `   sessionId: ${testCase.hasSessionId ? '‚úÖ' : '‚ùå'}\n`;
                    }
                    if (testCase.isMultiFile !== undefined) {
                      message += `   „Éû„É´„ÉÅ„Éï„Ç°„Ç§„É´: ${testCase.isMultiFile ? '‚úÖ' : '‚ùå'}\n`;
                    }
                  }
                  
                  if (testCase.isErrorResponse !== undefined && !testCase.case.includes('„Ç®„É©„Éº„ÉÜ„Çπ„Éà')) {
                    message += `   „Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ: ${testCase.isErrorResponse ? '‚úÖ' : '‚ùå'}\n`;
                  }
                });
              }
              
              alert(message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('‚ùå Âçò‰Ωì„ÉÜ„Çπ„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
            alert(`‚ùå Âçò‰Ωì„ÉÜ„Çπ„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº\n\n${error.message || error}`);
          })
          .testCreateAnalysisSessionUnit();
          
      } catch (error) {
        hideLoadingStatus();
        console.error('‚ùå Âçò‰Ωì„ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ:', error);
        alert(`‚ùå Âçò‰Ωì„ÉÜ„Çπ„ÉàÂÆüË°å‰æãÂ§ñ\n\n${error.message}`);
      }
    }

    function displayHealthResult(result) {
      hideLoadingStatus();
      
      if (result.success) {
        const health = result.health;
        const statusIcon = health.overall === 'healthy' ? '‚úÖ' : 
                          health.overall === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
        
        let message = `${statusIcon} „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß: ${health.overall}\n\n`;
        
        if (health.issues.length > 0) {
          message += `ÂïèÈ°å:\n${health.issues.join('\n')}\n\n`;
        }
        
        if (health.recommendations.length > 0) {
          message += `Êé®Â•®‰∫ãÈ†Ö:\n${health.recommendations.join('\n')}`;
        }
        
        alert(message);
      } else {
        alert(`‚ùå ÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº\n${result.error}`);
      }
    }


    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
    function showLoadingStatus(message) {
      document.getElementById('results').innerHTML = `<div class="loading">${message}</div>`;
    }

    function hideLoadingStatus() {
      // ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÊ¨°„ÅÆÂá¶ÁêÜ„Åß‰∏äÊõ∏„Åç„Åï„Çå„ÇãÔºâ
    }

    function handleError(error) {
      hideLoadingStatus();
      console.error('„Ç®„É©„Éº:', error);
      alert(`‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü\n${error.message || error}`);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Á∞°ÊòìÈÄöÁü•
        const originalText = event.target.textContent;
        event.target.textContent = '‚úÖ „Ç≥„Éî„ÉºÂÆå‰∫Ü';
        setTimeout(() => {
          event.target.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('„Ç≥„Éî„Éº„Ç®„É©„Éº:', err);
      });
    }

    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÔºàAIÂàÜÊûêÁî®Ôºâ
    let currentAnalysisSession = null;
    let analysisQuestionCounter = 0;
    let isAnalysisProcessing = false;

    // „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ©üËÉΩÔºàÁµ±ÂêàÁâàÔºâ
    function analyzeFile(fileId, fileName) {
      if (!fileId) {
        alert('‚ùå „Éï„Ç°„Ç§„É´ID„ÅåÁÑ°Âäπ„Åß„Åô');
        return;
      }
      
      console.log(`üî¨ „Éï„Ç°„Ç§„É´Ëß£ÊûêÈñãÂßã: ${fileName} (${fileId})`);
      
      try {
        // ÂàÜÊûê„Ç®„É™„Ç¢„ÇíË°®Á§∫
        showAnalysisArea(fileId, fileName);
        
        // ÂàÜÊûê„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Å®Âá¶ÁêÜÈñãÂßã
        startAnalysisSession(fileId, fileName);
        
        // ÊàêÂäüÈÄöÁü•
        const originalText = event.target.textContent;
        event.target.textContent = '‚úÖ ÂàÜÊûê„Ç®„É™„Ç¢„ÇíÈñã„Åç„Åæ„Åó„Åü';
        setTimeout(() => {
          event.target.textContent = originalText;
        }, 3000);
        
        // ÂàÜÊûê„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
        document.getElementById('analysisContainer').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
        
      } catch (error) {
        console.error('„Éï„Ç°„Ç§„É´Ëß£ÊûêÈñãÂßã„Ç®„É©„Éº:', error);
        alert(`‚ùå Ëß£ÊûêÈñãÂßã„Ç®„É©„Éº\n${error.message}`);
      }
    }

    // ÂàÜÊûê„Ç®„É™„Ç¢Ë°®Á§∫
    function showAnalysisArea(fileId, fileName) {
      const analysisContainer = document.getElementById('analysisContainer');
      const analysisFileName = document.getElementById('analysisFileName');
      
      analysisContainer.style.display = 'block';
      analysisFileName.textContent = `üìÑ ${fileName}`;
      
      // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Çí„É™„Çª„ÉÉ„Éà
      currentAnalysisSession = null;
      analysisQuestionCounter = 0;
      isAnalysisProcessing = false;
      
      // Ë≥™Âïè„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºà„Çª„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü„Åæ„ÅßÔºâ
      document.getElementById('analysisAskBtn').disabled = true;
      
      // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí„É™„Çª„ÉÉ„Éà
      const chatMessages = document.getElementById('analysisChatMessages');
      chatMessages.innerHTML = `
        <div class="chat-message assistant">
          <div class="message-header">ü§ñ Gemini AI</div>
          <div class="message-content">
            „Äå${fileName}„Äç„ÅÆËß£Êûê„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...<br>
            „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂÆå‰∫Ü„Åæ„ÅßÂ∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ
          </div>
        </div>
      `;
      
      updateAnalysisStatus('Ëß£ÊûêÊ∫ñÂÇô‰∏≠...');
      
      console.log('üîß „Éá„Éê„ÉÉ„Ç∞: ÂàÜÊûê„Ç®„É™„Ç¢Ë°®Á§∫ÂÆå‰∫Ü');
      console.log('üîß „Éï„Ç°„Ç§„É´ÊÉÖÂ†±:', { fileId, fileName });
    }

    // ÂàÜÊûê„Ç®„É™„Ç¢„ÇíÈñâ„Åò„Çã
    function closeAnalysis() {
      document.getElementById('analysisContainer').style.display = 'none';
      currentAnalysisSession = null;
      analysisQuestionCounter = 0;
      isAnalysisProcessing = false;
    }

    // ÂàÜÊûê„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã
    function startAnalysisSession(fileId, fileName) {
      try {
        isAnalysisProcessing = true;
        updateAnalysisStatus('Ëß£Êûê„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê‰∏≠...');
        
        console.log(`üîß „Éá„Éê„ÉÉ„Ç∞: „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÈñãÂßã - „Éï„Ç°„Ç§„É´ID: ${fileId}`);
        
        // GASÈñ¢Êï∞Âëº„Å≥Âá∫„Åó: Ëß£Êûê„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('üîß „Éá„Éê„ÉÉ„Ç∞: „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„É¨„Çπ„Éù„É≥„Çπ:', result);
            console.log('üîß „Éá„Éê„ÉÉ„Ç∞: „É¨„Çπ„Éù„É≥„Çπ„Çø„Ç§„Éó:', typeof result);
            console.log('üîß „Éá„Éê„ÉÉ„Ç∞: sessionIdÂ≠òÂú®:', !!(result && result.sessionId));
            console.log('üîß „Éá„Éê„ÉÉ„Ç∞: successÂÄ§:', result ? result.success : 'undefined');
            
            // null„Åæ„Åü„ÅØundefined„É¨„Çπ„Éù„É≥„Çπ„ÅÆÂ†¥Âêà
            if (result === null || result === undefined) {
              console.error('‚ùå „É¨„Çπ„Éù„É≥„Çπ„Åånull/undefined„Åß„Åô');
              updateAnalysisStatus('‚ùå GASÈñ¢Êï∞„Åã„Çânull„É¨„Çπ„Éù„É≥„Çπ');
              addAnalysisMessage('assistant', '‚ùå GASÈñ¢Êï∞„ÅåÊ≠£Â∏∏„Å´ÂÆüË°å„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇGAS„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
              isAnalysisProcessing = false;
              return;
            }
            
            // „Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ„ÅÆÂ†¥Âêà
            if (result && result.success === false) {
              console.error('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂ§±Êïó:', result.error);
              console.error('‚ùå „Ç®„É©„ÉºË©≥Á¥∞:', result.details);
              updateAnalysisStatus(`‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Ç®„É©„Éº: ${result.error}`);
              addAnalysisMessage('assistant', `‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Ç®„É©„Éº: ${result.error}`);
              isAnalysisProcessing = false;
              return;
            }
            
            // „É¨„Çπ„Éù„É≥„ÇπÊßãÈÄ†Ë©≥Á¥∞„É≠„Ç∞
            console.log('üîß „É¨„Çπ„Éù„É≥„ÇπË©≥Á¥∞ÂàÜÊûê:');
            console.log('  - result:', result);
            console.log('  - typeof result:', typeof result);
            console.log('  - result.sessionId:', result ? result.sessionId : 'N/A');
            console.log('  - result.fileIds:', result ? result.fileIds : 'N/A');
            console.log('  - result.success:', result ? result.success : 'N/A');
            console.log('  - Object.keys(result):', result ? Object.keys(result) : 'N/A');
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ID„ÅåÂ≠òÂú®„Åô„Çå„Å∞Âá¶ÁêÜ„ÇíÁ∂öË°åÔºàfileIds„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁ∑©ÂíåÔºâ
            if (result && result.sessionId) {
              currentAnalysisSession = result;
              console.log('‚úÖ Ëß£Êûê„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂÆå‰∫Ü:', currentAnalysisSession.sessionId);
              updateAnalysisStatus('„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂÆå‰∫Ü - „Éï„Ç°„Ç§„É´Ê∫ñÂÇô‰∏≠...');
              addAnalysisMessage('assistant', `‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂÆå‰∫Ü: ${result.sessionId.substring(0, 12)}`);
              prepareFileAnalysis(fileId);
            } else {
              console.error('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥ID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', result);
              console.error('ÊúüÂæÖ„Åï„Çå„ÇãÊßãÈÄ†: {sessionId, ...}');
              updateAnalysisStatus('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Åß‰∏çÊ≠£„Å™„É¨„Çπ„Éù„É≥„ÇπÊßãÈÄ†');
              addAnalysisMessage('assistant', `‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥ID„Å™„Åó: ${JSON.stringify(result)}`);
              isAnalysisProcessing = false;
            }
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêGAS„Ç®„É©„Éº:', error);
            updateAnalysisStatus(`‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: ${error.message || error}`);
            addAnalysisMessage('assistant', `‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Ç®„É©„Éº: ${error.message || error}`);
            isAnalysisProcessing = false;
          })
          .createAnalysisSession(fileId);
          
      } catch (error) {
        console.error('‚ùå Ëß£Êûê„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê‰æãÂ§ñ:', error);
        updateAnalysisStatus(`‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê‰æãÂ§ñ: ${error.message}`);
        addAnalysisMessage('assistant', `‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê‰æãÂ§ñ: ${error.message}`);
        isAnalysisProcessing = false;
      }
    }

    // „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇô
    function prepareFileAnalysis(fileId) {
      try {
        updateAnalysisStatus('„Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇô‰∏≠...');
        console.log('üîß „Éá„Éê„ÉÉ„Ç∞: „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇôÈñãÂßã');
        console.log('üîß „Éá„Éê„ÉÉ„Ç∞: „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±:', currentAnalysisSession);
        
        // GASÈñ¢Êï∞Âëº„Å≥Âá∫„Åó: „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇô
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('üîß „Éá„Éê„ÉÉ„Ç∞: „Éï„Ç°„Ç§„É´Ê∫ñÂÇô„É¨„Çπ„Éù„É≥„Çπ:', result);
            
            // „Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ„ÅÆÂ†¥Âêà
            if (result && result.success === false) {
              console.error('‚ùå „Éï„Ç°„Ç§„É´Ê∫ñÂÇôÂ§±Êïó:', result.error);
              updateAnalysisStatus(`‚ùå „Éï„Ç°„Ç§„É´Ê∫ñÂÇô„Ç®„É©„Éº: ${result.error}`);
              addAnalysisMessage('assistant', `‚ùå „Éï„Ç°„Ç§„É´Ê∫ñÂÇô„Ç®„É©„Éº: ${result.error}`);
              isAnalysisProcessing = false;
              return;
            }
            
            // Ê≠£Â∏∏ÂÆå‰∫Ü„ÅÆÂ†¥Âêà
            console.log('‚úÖ „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇôÂÆå‰∫Ü');
            updateAnalysisStatus('‚úÖ Ê∫ñÂÇôÂÆå‰∫Ü - Ë≥™Âïè„Çí„Å©„ÅÜ„ÅûÔºÅ');
            addAnalysisMessage('assistant', '‚úÖ „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇôÂÆå‰∫ÜÔºÅ‰Ωï„Åß„ÇÇË≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            isAnalysisProcessing = false;
            
            // Ë≥™ÂïèÂÖ•Âäõ„ÇíÊúâÂäπÂåñ
            document.getElementById('analysisAskBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå „Éï„Ç°„Ç§„É´Ê∫ñÂÇôGAS„Ç®„É©„Éº:', error);
            updateAnalysisStatus(`‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: ${error.message || error}`);
            addAnalysisMessage('assistant', `‚ùå „Éï„Ç°„Ç§„É´Ê∫ñÂÇô„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: ${error.message || error}`);
            isAnalysisProcessing = false;
          })
          .prepareFileForAnalysis(currentAnalysisSession);
          
      } catch (error) {
        console.error('‚ùå „Éï„Ç°„Ç§„É´Ëß£ÊûêÊ∫ñÂÇô‰æãÂ§ñ:', error);
        updateAnalysisStatus(`‚ùå Ê∫ñÂÇô‰æãÂ§ñ: ${error.message}`);
        addAnalysisMessage('assistant', `‚ùå „Éï„Ç°„Ç§„É´Ê∫ñÂÇô‰æãÂ§ñ: ${error.message}`);
        isAnalysisProcessing = false;
      }
    }

    // Ë≥™Âïè‰æã„Çí„Çª„ÉÉ„Éà
    function setAnalysisQuestion(question) {
      document.getElementById('analysisQuestionInput').value = question;
    }

    // AIË≥™ÂïèÂá¶ÁêÜ
    async function askAnalysisQuestion() {
      const questionInput = document.getElementById('analysisQuestionInput');
      const question = questionInput.value.trim();
      
      if (!question) {
        alert('Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      // „Éá„Éê„ÉÉ„Ç∞: „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖãÁ¢∫Ë™ç
      console.log('üîß „Éá„Éê„ÉÉ„Ç∞: Ë≥™ÂïèÂá¶ÁêÜÈñãÂßã');
      console.log('üîß currentAnalysisSession:', currentAnalysisSession);
      console.log('üîß isAnalysisProcessing:', isAnalysisProcessing);
      
      if (!currentAnalysisSession) {
        const errorMsg = `ÂàÜÊûê„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
        
„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:
- „Çª„ÉÉ„Ç∑„Éß„É≥„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà: ${currentAnalysisSession}
- Âá¶ÁêÜ‰∏≠„Éï„É©„Ç∞: ${isAnalysisProcessing}
        
„Äåüî¨ AIËß£Êûê„Äç„Éú„Çø„É≥„ÇíÂÜçÂ∫¶„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂàÜÊûê„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
        
        alert(errorMsg);
        updateAnalysisStatus('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥Êú™ÈñãÂßã - ÂÜçÂ∫¶AIËß£Êûê„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ');
        return;
      }
      
      if (isAnalysisProcessing) {
        alert('Âá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      try {
        isAnalysisProcessing = true;
        questionInput.value = '';
        document.getElementById('analysisAskBtn').disabled = true;
        
        // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
        addAnalysisMessage('user', question);
        
        // „ÄåÂõûÁ≠îÁîüÊàê‰∏≠...„Äç„É°„ÉÉ„Çª„Éº„Ç∏
        const loadingMessageId = addAnalysisMessage('assistant', 'ÂõûÁ≠î„ÇíÁîüÊàê‰∏≠...', true);
        
        updateAnalysisStatus('AIÂõûÁ≠îÁîüÊàê‰∏≠...');
        
        // ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
        showFullScreenLoading('AIÂõûÁ≠îÁîüÊàê‰∏≠...', 'Gemini„ÅßË≥™Âïè„ÇíÂá¶ÁêÜ„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàÈÄöÂ∏∏10-15ÁßíÔºâ', 'Ë≥™ÂïèÈÄÅ‰ø°ÂÆå‰∫Ü');
        
        // ÂÆüÈöõ„ÅÆGemini APIÂëº„Å≥Âá∫„Åó
        google.script.run
          .withSuccessHandler(function(response) {
            console.log('üîß Ë≥™Âïè„É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', response);
            console.log('üîß „É¨„Çπ„Éù„É≥„ÇπÂûã:', typeof response);
            console.log('üîß successÂÄ§:', response?.success);
            
            // ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
            hideFullScreenLoading();
            
            removeAnalysisMessage(loadingMessageId);
            
            // null/undefined „ÉÅ„Çß„ÉÉ„ÇØ
            if (response === null || response === undefined) {
              addAnalysisMessage('assistant', '‚ùå GASÈñ¢Êï∞„Åã„ÇâÁÑ°Âäπ„Å™„É¨„Çπ„Éù„É≥„Çπ„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü');
              updateAnalysisStatus('‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº');
              isAnalysisProcessing = false;
              document.getElementById('analysisAskBtn').disabled = false;
              return;
            }
            
            if (response.success) {
              console.log('üîß ÊàêÂäü„É¨„Çπ„Éù„É≥„Çπ - ÂõûÁ≠îË°®Á§∫');
              addAnalysisMessage('assistant', response.response);
              analysisQuestionCounter++;
              updateAnalysisStatus('‚úÖ Ê∫ñÂÇôÂÆå‰∫Ü - Ë≥™Âïè„Çí„Å©„ÅÜ„ÅûÔºÅ');
              
              // Âàá„ÇäË©∞„ÇÅ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
              if (response.truncated) {
                addAnalysisMessage('assistant', 'üí° ÂõûÁ≠î„ÅåÈï∑„ÅÑ„Åü„ÇÅÁúÅÁï•„Åï„Çå„Åæ„Åó„Åü„ÄÇË©≥Á¥∞„Å™ÂàÜÊûêÁµêÊûú„ÅØÂ±•Ê≠¥Ê©üËÉΩ„Åã„ÇâÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ');
              }
            } else {
              console.log('üîß „Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', response.error);
              addAnalysisMessage('assistant', `‚ùå „Ç®„É©„Éº: ${response.error}`);
              updateAnalysisStatus('‚ùå Ë≥™ÂïèÂá¶ÁêÜ„Ç®„É©„Éº');
            }
            
            isAnalysisProcessing = false;
            document.getElementById('analysisAskBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            // ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
            hideFullScreenLoading();
            
            removeAnalysisMessage(loadingMessageId);
            addAnalysisMessage('assistant', `‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: ${error.message || error}`);
            
            updateAnalysisStatus('‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            isAnalysisProcessing = false;
            document.getElementById('analysisAskBtn').disabled = false;
          })
          .processAnalysisQuestion(currentAnalysisSession, question);

      } catch (error) {
        // ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
        hideFullScreenLoading();
        
        console.error('Ë≥™ÂïèÂá¶ÁêÜ„Ç®„É©„Éº:', error);
        updateAnalysisStatus(`‚ùå Ë≥™ÂïèÂá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`);
        isAnalysisProcessing = false;
        document.getElementById('analysisAskBtn').disabled = false;
      }
    }

    // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
    function addAnalysisMessage(type, content, isLoading = false) {
      const chatMessages = document.getElementById('analysisChatMessages');
      const messageId = 'analysis_msg_' + Date.now();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}`;
      messageDiv.id = messageId;
      
      const header = type === 'user' ? 'üë§ „É¶„Éº„Ç∂„Éº' : 'ü§ñ Gemini AI';
      
      // „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥Ëß£ÊûêÔºàAI„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„ÅøÔºâ
      let processedContent = content;
      if (type === 'assistant' && !isLoading && typeof marked !== 'undefined') {
        try {
          // XSSÊîªÊíÉÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ„ÅÆË®≠ÂÆö
          marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            smartLists: true,
            smartypants: false
          });
          
          processedContent = marked.parse(content);
          console.log('üé® „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥Ëß£ÊûêÂÆå‰∫Ü');
        } catch (error) {
          console.warn('‚ö†Ô∏è „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥Ëß£Êûê„Ç®„É©„Éº:', error);
          processedContent = content; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        }
      }
      
      messageDiv.innerHTML = `
        <div class="message-header">${header}</div>
        <div class="message-content">${processedContent}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageId;
    }

    // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§
    function removeAnalysisMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // ÂàÜÊûê„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
    function updateAnalysisStatus(status) {
      document.getElementById('analysisStatus').textContent = status || 'Ê∫ñÂÇôÂÆå‰∫Ü';
    }

    // „Ç®„É≥„Çø„Éº„Ç≠„Éº„ÅßË≥™ÂïèÈÄÅ‰ø°
    document.addEventListener('DOMContentLoaded', function() {
      const questionInput = document.getElementById('analysisQuestionInput');
      if (questionInput) {
        questionInput.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            askAnalysisQuestion();
          }
        });
      }
    });

    // ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞Âà∂Âæ°Èñ¢Êï∞
    function showFullScreenLoading(text = 'AIÂá¶ÁêÜ‰∏≠...', subtext = 'Âá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ', progress = 'Âá¶ÁêÜÈñãÂßã') {
      const loadingElement = document.getElementById('fullScreenLoading');
      const loadingText = document.getElementById('loadingText');
      const loadingSubtext = document.getElementById('loadingSubtext');
      const loadingProgress = document.getElementById('loadingProgress');
      
      if (loadingElement) {
        loadingText.textContent = text;
        loadingSubtext.textContent = subtext;
        loadingProgress.textContent = progress;
        loadingElement.classList.remove('hidden');
        
        // „Éú„Éá„Ç£„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°ÂäπÂåñ
        document.body.style.overflow = 'hidden';
        
        console.log('üîÑ ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫:', text);
      }
    }
    
    function hideFullScreenLoading() {
      const loadingElement = document.getElementById('fullScreenLoading');
      
      if (loadingElement) {
        loadingElement.classList.add('hidden');
        
        // „Éú„Éá„Ç£„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂæ©ÂÖÉ
        document.body.style.overflow = '';
        
        console.log('‚úÖ ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫');
      }
    }
    
    function updateFullScreenLoadingProgress(progress) {
      const loadingProgress = document.getElementById('loadingProgress');
      if (loadingProgress) {
        loadingProgress.textContent = progress;
        console.log('üìä „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈÄ≤ÊçóÊõ¥Êñ∞:', progress);
      }
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener('keydown', function(e) {
      // Ctrl+Enter „ÅßÊ§úÁ¥¢
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        performSearch();
      }
    });
  </script>
</body>
</html>