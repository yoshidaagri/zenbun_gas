<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ—ï¸ ãƒ‡ã‚¶ã‚¤ãƒ³äº‹å‹™æ‰€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  v2.0</title>
  
  <!-- Markdown parser library -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* ã‚«ãƒ¼ã‚­è‰²ã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    :root {
      --primary-khaki: #8B9A5B;
      --light-khaki: #A8B373;
      --pale-khaki: #C5D197;
      --cream-khaki: #F5F7F0;
      --dark-khaki: #6B7A47;
      --accent-khaki: #9CAD6B;
      --shadow-khaki: rgba(139, 154, 91, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      background: linear-gradient(135deg, var(--pale-khaki) 0%, var(--cream-khaki) 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .header {
      text-align: center;
      background: white;
      padding: 32px 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px var(--shadow-khaki);
      margin-bottom: 24px;
      border-left: 6px solid var(--primary-khaki);
    }
    
    .header h1 {
      margin: 0 0 16px 0;
      color: var(--primary-khaki);
      font-size: clamp(24px, 5vw, 32px);
      font-weight: 700;
    }
    
    .header p {
      color: #666;
      font-size: clamp(14px, 3vw, 16px);
      margin: 12px 0;
    }

    .version-badge {
      display: inline-block;
      background: var(--accent-khaki);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }
    
    .workflow {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin: 20px 0;
    }
    
    .workflow-step {
      background: var(--cream-khaki);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: clamp(12px, 2.5vw, 14px);
      color: var(--dark-khaki);
      font-weight: 500;
      border: 1px solid var(--pale-khaki);
    }
    
    .search-container {
      background: white;
      padding: clamp(20px, 4vw, 30px);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      margin-bottom: 24px;
    }
    
    .search-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .search-header h2 {
      color: var(--primary-khaki);
      margin: 0 0 12px 0;
      font-size: clamp(20px, 4vw, 24px);
    }
    
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    #searchInput {
      flex: 1;
      min-width: 200px;
      padding: 16px 18px;
      border: 2px solid var(--pale-khaki);
      border-radius: 12px;
      font-size: clamp(14px, 3vw, 16px);
      transition: all 0.3s ease;
      background: var(--cream-khaki);
    }
    
    #searchInput:focus {
      outline: none;
      border-color: var(--primary-khaki);
      box-shadow: 0 0 0 4px var(--shadow-khaki);
      background: white;
    }
    
    #searchBtn {
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: clamp(14px, 3vw, 16px);
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px var(--shadow-khaki);
      min-width: 80px;
      white-space: nowrap;
    }
    
    #searchBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-khaki);
    }
    
    #searchBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .search-examples {
      background: var(--cream-khaki);
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 16px;
      border: 1px solid var(--pale-khaki);
    }
    
    .search-examples h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: clamp(13px, 2.5vw, 14px);
    }
    
    .example-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .example-tag {
      background: white;
      color: var(--primary-khaki);
      padding: 6px 14px;
      border-radius: 16px;
      font-size: clamp(12px, 2.5vw, 13px);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--pale-khaki);
    }
    
    .example-tag:hover {
      background: var(--primary-khaki);
      color: white;
      transform: translateY(-1px);
    }
    
    .loading {
      text-align: center;
      padding: clamp(30px, 6vw, 50px);
      color: #666;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
    }
    
    .loading::before {
      content: '';
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--pale-khaki);
      border-top: 3px solid var(--primary-khaki);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .full-screen-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(45, 45, 45, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }
    
    .full-screen-loading.hidden {
      display: none;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--primary-khaki);
      border-radius: 50%;
      animation: spin 1.2s linear infinite;
      margin-bottom: 24px;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .loading-subtext {
      font-size: 14px;
      opacity: 0.8;
      text-align: center;
      max-width: 300px;
      line-height: 1.5;
    }
    
    .loading-progress {
      margin-top: 20px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
    }
    
    .results-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      overflow: hidden;
    }
    
    .results-header {
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .results-header h3 {
      margin: 0;
      font-size: clamp(16px, 3.5vw, 20px);
    }
    
    .results-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: clamp(12px, 2.5vw, 14px);
      font-weight: 500;
    }
    
    .result-item {
      padding: 24px;
      border-bottom: 1px solid var(--pale-khaki);
      transition: background 0.2s ease;
    }
    
    .result-item:hover {
      background: var(--cream-khaki);
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .result-title {
      font-size: clamp(14px, 3vw, 16px);
      font-weight: 600;
      color: var(--dark-khaki);
      margin: 0;
      flex: 1;
      min-width: 200px;
    }
    
    .result-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .result-type {
      background: var(--accent-khaki);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: clamp(10px, 2vw, 12px);
      font-weight: 500;
    }
    
    .result-date {
      color: #888;
      font-size: clamp(10px, 2vw, 12px);
    }
    
    .result-summary {
      color: #555;
      font-size: clamp(13px, 2.8vw, 14px);
      margin: 12px 0;
      line-height: 1.5;
    }
    
    .result-preview {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: clamp(11px, 2.3vw, 12px);
      color: #666;
      margin: 12px 0;
      border-left: 4px solid var(--pale-khaki);
    }
    
    .result-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: clamp(12px, 2.5vw, 13px);
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }
    
    .btn-primary {
      background: var(--primary-khaki);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--dark-khaki);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--cream-khaki);
      color: var(--dark-khaki);
      border: 1px solid var(--pale-khaki);
    }
    
    .btn-secondary:hover {
      background: var(--pale-khaki);
    }
    
    .no-results {
      text-align: center;
      padding: clamp(40px, 8vw, 60px);
      color: #666;
    }
    
    .no-results h3 {
      color: var(--primary-khaki);
      margin-bottom: 16px;
      font-size: clamp(18px, 4vw, 22px);
    }
    
    .management-container {
      background: white;
      padding: clamp(20px, 4vw, 30px);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      margin-top: 24px;
    }
    
    .management-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .management-header h3 {
      color: var(--primary-khaki);
      margin: 0 0 12px 0;
      font-size: clamp(18px, 4vw, 20px);
    }
    
    .management-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .mgmt-btn {
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--light-khaki) 0%, var(--primary-khaki) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: clamp(13px, 3vw, 14px);
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .mgmt-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-khaki);
    }
    
    .mgmt-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-display {
      background: var(--cream-khaki);
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--pale-khaki);
      margin-top: 16px;
    }
    
    .status-display h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: clamp(14px, 3vw, 15px);
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--pale-khaki);
      font-size: clamp(12px, 2.5vw, 13px);
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-value {
      font-weight: 600;
      color: var(--primary-khaki);
    }

    /* AIåˆ†æã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .analysis-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      margin-top: 24px;
      overflow: hidden;
    }

    .analysis-header {
      background: linear-gradient(135deg, var(--accent-khaki) 0%, var(--primary-khaki) 100%);
      color: white;
      padding: 20px 24px;
      position: relative;
    }

    .analysis-header h3 {
      margin: 0 0 8px 0;
      font-size: clamp(18px, 4vw, 22px);
    }

    .analysis-header p {
      margin: 0;
      opacity: 0.9;
      font-size: clamp(13px, 3vw, 14px);
    }

    .close-analysis-btn {
      position: absolute;
      top: 20px;
      right: 24px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s ease;
    }

    .close-analysis-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .analysis-content {
      padding: 24px;
    }

    .analysis-file-info {
      background: var(--cream-khaki);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid var(--pale-khaki);
    }

    .analysis-file-info h4 {
      margin: 0 0 8px 0;
      color: var(--dark-khaki);
      font-size: clamp(14px, 3vw, 16px);
    }

    #analysisFileName {
      font-weight: 600;
      color: var(--primary-khaki);
      font-size: clamp(13px, 3vw, 15px);
    }

    .analysis-chat {
      background: var(--cream-khaki);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .chat-messages {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid var(--pale-khaki);
    }

    .chat-message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 12px;
    }

    .chat-message.assistant {
      background: #f3e5f5;
      border-left: 4px solid var(--accent-khaki);
    }

    .chat-message.user {
      background: #e3f2fd;
      border-left: 4px solid var(--primary-khaki);
      margin-left: 20px;
    }

    .message-header {
      font-weight: 600;
      font-size: 13px;
      color: var(--dark-khaki);
      margin-bottom: 6px;
    }

    .message-content {
      font-size: clamp(13px, 3vw, 14px);
      line-height: 1.5;
      color: #333;
    }
    
    /* Markdown ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
      color: var(--primary-khaki);
      margin: 12px 0 8px 0;
      font-weight: 600;
    }
    
    .message-content h2 {
      font-size: 16px;
      border-bottom: 2px solid var(--pale-khaki);
      padding-bottom: 4px;
    }
    
    .message-content h3 {
      font-size: 14px;
    }
    
    .message-content ul, .message-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .message-content li {
      margin: 4px 0;
      line-height: 1.4;
    }
    
    .message-content strong {
      color: var(--dark-khaki);
      font-weight: 600;
    }
    
    .message-content em {
      color: var(--primary-khaki);
      font-style: italic;
    }
    
    .message-content code {
      background: var(--pale-khaki);
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    
    .message-content pre {
      background: var(--pale-khaki);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }
    
    .message-content blockquote {
      border-left: 4px solid var(--primary-khaki);
      margin: 8px 0;
      padding: 8px 0 8px 12px;
      background: rgba(139, 154, 91, 0.05);
      font-style: italic;
    }
    
    .message-content p {
      margin: 8px 0;
    }
    
    .message-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 8px 0;
      font-size: 13px;
    }
    
    .message-content th, .message-content td {
      border: 1px solid var(--pale-khaki);
      padding: 6px 8px;
      text-align: left;
    }
    
    .message-content th {
      background: var(--pale-khaki);
      font-weight: 600;
      color: var(--dark-khaki);
    }

    .question-examples {
      margin-bottom: 16px;
    }

    .question-examples h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: clamp(13px, 3vw, 14px);
    }

    .example-questions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .example-question {
      background: white;
      color: var(--primary-khaki);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: clamp(11px, 2.5vw, 12px);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--pale-khaki);
    }

    .example-question:hover {
      background: var(--primary-khaki);
      color: white;
      transform: translateY(-1px);
    }

    .input-area {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    #analysisQuestionInput {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--pale-khaki);
      border-radius: 8px;
      font-size: clamp(13px, 3vw, 14px);
      resize: vertical;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }

    #analysisQuestionInput:focus {
      outline: none;
      border-color: var(--primary-khaki);
      box-shadow: 0 0 0 4px var(--shadow-khaki);
    }

    #analysisAskBtn {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(13px, 3vw, 14px);
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    #analysisAskBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow-khaki);
    }

    #analysisAskBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .analysis-status {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-radius: 8px;
      text-align: center;
      font-size: clamp(12px, 2.5vw, 13px);
      color: var(--dark-khaki);
      border: 1px solid var(--pale-khaki);
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .search-box {
        flex-direction: column;
      }
      
      #searchBtn {
        width: 100%;
      }
      
      .result-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .result-actions {
        justify-content: center;
      }
      
      .management-buttons {
        grid-template-columns: 1fr;
      }
    }
    
    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç† */
    .focusable:focus {
      outline: 2px solid var(--primary-khaki);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="full-screen-loading hidden" id="fullScreenLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">AIè§£æå‡¦ç†ä¸­...</div>
    <div class="loading-subtext" id="loadingSubtext">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Geminiã§è§£æã—ã€AIå›ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™</div>
    <div class="loading-progress" id="loadingProgress">æº–å‚™ä¸­...</div>
  </div>

  <div class="header">
    <h1>ğŸ—ï¸ ãƒ‡ã‚¶ã‚¤ãƒ³äº‹å‹™æ‰€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>googledriveã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’AIãŒè¦ç´„ã—ã¦æ¤œç´¢å¯èƒ½ã«ã—ã¾ã™</p>
    <p>ã€ŒAæ¡ˆä»¶ã®å›³é¢ã€ã®ã‚ˆã†ãªæ›–æ˜§ãªä¾é ¼ã«ã‚‚AIãŒå¯¾å¿œã—ã¾ã™</p>
    
    <div class="workflow">
      <span class="workflow-step">ğŸ“ Google Drive</span>
      <span class="workflow-step">ğŸ¤– Gemini AIè¦ç´„</span>
      <span class="workflow-step">ğŸ“Š æ¤œç´¢ãƒ»è¡¨ç¤º</span>
    </div>
  </div>

  <div class="search-container">
    <div class="search-header">
      <h2>ğŸ” ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢</h2>
      <p>ãƒ•ã‚¡ã‚¤ãƒ«åã€å†…å®¹ã€AIè¦ç´„ã‹ã‚‰æ¨ªæ–­æ¤œç´¢ã§ãã¾ã™</p>
    </div>
    
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ä¾‹: è¨­è¨ˆ, å¹³é¢å›³, ã‚«ãƒ•ã‚§è¨­è¨ˆ..." 
             onkeydown="if(event.key==='Enter')performSearch()">
      <button id="searchBtn" onclick="performSearch()">æ¤œç´¢</button>
    </div>
    
    <div class="search-examples">
      <h4>ğŸ¯ æ¤œç´¢ä¾‹ (ã‚¯ãƒªãƒƒã‚¯ã§æ¤œç´¢)</h4>
      <div class="example-tags">
        <span class="example-tag" onclick="searchExample('')">å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</span>
        <span class="example-tag" onclick="searchExample('è¨­è¨ˆ')">è¨­è¨ˆ</span>
        <span class="example-tag" onclick="searchExample('å¹³é¢å›³')">å¹³é¢å›³</span>
        <span class="example-tag" onclick="searchExample('ã‚«ãƒ•ã‚§')">ã‚«ãƒ•ã‚§</span>
        <span class="example-tag" onclick="searchExample('ä½å®…')">ä½å®…</span>
        <span class="example-tag" onclick="searchExample('ãƒ†ãƒ©ã‚¹')">ãƒ†ãƒ©ã‚¹</span>
        <span class="example-tag" onclick="searchExample('2éš')">2éš</span>
      </div>
    </div>
  </div>

  <div id="results"></div>

  <!-- AIåˆ†æã‚¨ãƒªã‚¢ -->
  <div class="analysis-container" id="analysisContainer" style="display: none;">
    <div class="analysis-header">
      <h3>ğŸ”¬ AI ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æãƒ»ãƒãƒ£ãƒƒãƒˆ</h3>
      <p>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’AIã§è©³ç´°åˆ†æã—ã€è³ªå•å¿œç­”ã§ãã¾ã™</p>
      <button class="close-analysis-btn" onclick="closeAnalysis()">âœ• åˆ†æã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="analysis-content">
      <!-- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º -->
      <div class="analysis-file-info" id="analysisFileInfo">
        <h4>ğŸ“„ è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«</h4>
        <div id="analysisFileName">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      </div>
      
      <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
      <div class="analysis-chat">
        <div class="chat-messages" id="analysisChatMessages">
          <div class="chat-message assistant">
            <div class="message-header">ğŸ¤– Gemini AI</div>
            <div class="message-content">
              ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã‚’é–‹å§‹ã—ã¾ã™ï¼<br>
              **ç°¡æ½”ãªå›ç­”**ã§ãŠç­”ãˆã—ã¾ã™ã®ã§ã€æ°—è»½ã«è³ªå•ã—ã¦ãã ã•ã„ã€‚<br>
              ğŸ“ ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è¦‹ã‚„ã™ãè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
          </div>
        </div>
        
        <!-- è³ªå•å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="question-input">
          <div class="question-examples">
            <h4>ğŸ’¡ è³ªå•ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ï¼‰</h4>
            <div class="example-questions">
              <span class="example-question" onclick="setAnalysisQuestion('ã“ã®å›³é¢ã®æ¦‚è¦ã‚’æ•™ãˆã¦ãã ã•ã„')">å›³é¢ã®æ¦‚è¦</span>
              <span class="example-question" onclick="setAnalysisQuestion('ä¸»è¦ãªå¯¸æ³•ã¨æ§‹é€ ã‚’æ•™ãˆã¦')">å¯¸æ³•ãƒ»æ§‹é€ </span>
              <span class="example-question" onclick="setAnalysisQuestion('ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç‰¹å¾´ã‚’ç°¡æ½”ã«')">ãƒ‡ã‚¶ã‚¤ãƒ³ç‰¹å¾´</span>
              <span class="example-question" onclick="setAnalysisQuestion('æ”¹å–„ç‚¹ã‚’3ã¤æ•™ãˆã¦')">æ”¹å–„ææ¡ˆ</span>
              <span class="example-question" onclick="setAnalysisQuestion('ç”¨é€”ã¨æ©Ÿèƒ½ã‚’æ•™ãˆã¦')">ç”¨é€”ãƒ»æ©Ÿèƒ½</span>
              <span class="example-question" onclick="setAnalysisQuestion('æ³¨æ„ã™ã¹ãç‚¹ã¯ï¼Ÿ')">æ³¨æ„ç‚¹</span>
            </div>
          </div>
          
          <div class="input-area">
            <textarea id="analysisQuestionInput" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„..." rows="3"></textarea>
            <button id="analysisAskBtn" onclick="askAnalysisQuestion()">è³ªå•ã™ã‚‹</button>
          </div>
        </div>
      </div>
      
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div class="analysis-status" id="analysisStatus">
        æº–å‚™å®Œäº†
      </div>
    </div>
  </div>

  <div class="management-container">
    <div class="management-header">
      <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</h3>
      <p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè§£æã‚„ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™</p>
    </div>
    
    <div class="management-buttons">
      <button class="mgmt-btn" onclick="analyzeNewDocuments()">ğŸ“Š æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè§£æ</button>
      <button class="mgmt-btn" onclick="showAllDocuments()">ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¡¨ç¤º</button>
      <button class="mgmt-btn" onclick="testGeminiConnection()">ğŸ¤– Geminiæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      <button class="mgmt-btn" onclick="runDebugTests()">ğŸ”§ è©³ç´°ãƒ‡ãƒãƒƒã‚°</button>
      <button class="mgmt-btn" onclick="testSearchStats()">ğŸ“Š æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆ</button>
      <button class="mgmt-btn" onclick="testAnalysisConnection()">ğŸ§ª AIåˆ†ææ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      <button class="mgmt-btn" onclick="testAnalysisManagerDetails()">ğŸ” AnalysisManagerè©³ç´°ãƒ†ã‚¹ãƒˆ</button>
      <button class="mgmt-btn" onclick="testCreateAnalysisSessionUnit()">âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå˜ä½“ãƒ†ã‚¹ãƒˆ</button>
      <button class="mgmt-btn" onclick="checkSystemHealth()">ğŸ©º ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯</button>
    </div>

    <div class="status-display" id="systemStatus">
      <h4>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h4>
      <div class="status-item">
        <span>ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
        <span class="status-value">ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç‰ˆ v2.0</span>
      </div>
      <div class="status-item">
        <span>æœ€çµ‚æ›´æ–°</span>
        <span class="status-value" id="lastUpdate">-</span>
      </div>
      <div class="status-item">
        <span>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹</span>
        <span class="status-value" id="dbStatus">ç¢ºèªä¸­...</span>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let isSearching = false;
    let currentSystemInfo = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('load', function() {
      console.log('ğŸš€ ãƒ‡ã‚¶ã‚¤ãƒ³äº‹å‹™æ‰€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  v2.0 èµ·å‹•');
      updateSystemStatus();
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      document.getElementById('searchInput').focus();
    });

    // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°
    async function updateSystemStatus() {
      try {
        const info = await google.script.run
          .withSuccessHandler(updateStatusDisplay)
          .withFailureHandler(handleError)
          .getSystemInfo();
      } catch (error) {
        console.error('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('dbStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
      }
    }

    function updateStatusDisplay(info) {
      currentSystemInfo = info;
      document.getElementById('lastUpdate').textContent = info.timestamp || '-';
      
      if (info.config) {
        const configStatus = Object.values(info.config).every(Boolean) ? 'æ­£å¸¸' : 'è¨­å®šä¸å®Œå…¨';
        document.getElementById('dbStatus').textContent = configStatus;
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½
    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      
      if (isSearching) {
        console.log('âš ï¸ æ¤œç´¢ä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }
      
      console.log(`ğŸ” æ¤œç´¢é–‹å§‹: "${query}"`);
      isSearching = true;
      
      const searchBtn = document.getElementById('searchBtn');
      const originalText = searchBtn.textContent;
      
      try {
        // UIæ›´æ–°
        searchBtn.disabled = true;
        searchBtn.textContent = 'æ¤œç´¢ä¸­...';
        document.getElementById('results').innerHTML = '<div class="loading">æ¤œç´¢ä¸­ã§ã™...</div>';
        
        // æ¤œç´¢å®Ÿè¡Œ
        const results = await google.script.run
          .withSuccessHandler(displaySearchResults)
          .withFailureHandler(handleSearchError)
          .searchDocuments(query);
          
      } catch (error) {
        console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        handleSearchError(error);
      } finally {
        // UIå¾©å…ƒ
        searchBtn.disabled = false;
        searchBtn.textContent = originalText;
        isSearching = false;
      }
    }

    function displaySearchResults(results) {
      console.log('ğŸ“Š æ¤œç´¢çµæœå—ä¿¡:', results);
      
      const resultsDiv = document.getElementById('results');
      
      if (!results || !Array.isArray(results) || results.length === 0) {
        resultsDiv.innerHTML = `
          <div class="results-container">
            <div class="no-results">
              <h3>ğŸ“­ æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
              <p>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„</p>
              <p>ã¾ãŸã¯ã€Œå…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã§å…¨ä»¶ã‚’ç¢ºèªã§ãã¾ã™</p>
            </div>
          </div>
        `;
        return;
      }
      
      const resultsHtml = `
        <div class="results-container">
          <div class="results-header">
            <h3>ğŸ“‹ æ¤œç´¢çµæœ</h3>
            <div class="results-count">${results.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>
          </div>
          ${results.map(result => createResultItemHtml(result)).join('')}
        </div>
      `;
      
      resultsDiv.innerHTML = resultsHtml;
      
      // çµæœã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function createResultItemHtml(result) {
      const fileName = result.fileName || 'ä¸æ˜ãªãƒ•ã‚¡ã‚¤ãƒ«';
      const aiSummary = result.aiSummary || 'è¦ç´„ãªã—';
      const extractedText = result.extractedText || '';
      const fileType = result.fileType || 'ä¸æ˜';
      const updateDate = result.updateDate || '-';
      const viewUrl = result.viewUrl || '#';
      
      return `
        <div class="result-item">
          <div class="result-header">
            <h4 class="result-title">ğŸ“„ ${fileName}</h4>
            <div class="result-meta">
              <span class="result-type">${fileType}</span>
              <span class="result-date">${updateDate}</span>
            </div>
          </div>
          
          <div class="result-summary">${aiSummary}</div>
          
          ${extractedText ? `<div class="result-preview">ğŸ“ æŠ½å‡ºãƒ†ã‚­ã‚¹ãƒˆ: ${extractedText}</div>` : ''}
          
          <div class="result-actions">
            <a href="${viewUrl}" target="_blank" class="action-btn btn-primary">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>
            <button class="action-btn btn-secondary" onclick="copyToClipboard('${fileName}')">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«åã‚³ãƒ”ãƒ¼</button>
            <button class="action-btn btn-primary" onclick="analyzeFile('${result.fileId}', '${fileName}')">ğŸ”¬ AIè§£æ</button>
          </div>
        </div>
      `;
    }

    function handleSearchError(error) {
      console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
      document.getElementById('results').innerHTML = `
        <div class="results-container">
          <div class="no-results">
            <h3>âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
            <p>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„</p>
            <p>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message || error}</p>
          </div>
        </div>
      `;
    }

    // æ¤œç´¢ä¾‹å®Ÿè¡Œ
    function searchExample(query) {
      document.getElementById('searchInput').value = query;
      performSearch();
    }

    // ç®¡ç†æ©Ÿèƒ½
    async function analyzeNewDocuments() {
      if (confirm('æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè§£æã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nâ€» å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™')) {
        try {
          showLoadingStatus('ğŸ“Š æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè§£æä¸­...');
          
          const result = await google.script.run
            .withSuccessHandler(handleAnalysisResult)
            .withFailureHandler(handleError)
            .analyzeDocuments();
            
        } catch (error) {
          handleError(error);
        }
      }
    }

    function handleAnalysisResult(result) {
      hideLoadingStatus();
      
      if (result.success) {
        alert(`âœ… è§£æå®Œäº†\nå‡¦ç†: ${result.processed}ä»¶\nã‚¹ã‚­ãƒƒãƒ—: ${result.skipped}ä»¶\nã‚¨ãƒ©ãƒ¼: ${result.errors}ä»¶`);
        updateSystemStatus();
      } else {
        alert(`âŒ è§£æã‚¨ãƒ©ãƒ¼\n${result.error}`);
      }
    }

    async function showAllDocuments() {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              window.open(result.url, '_blank');
            } else {
              alert(`âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLå–å¾—ã‚¨ãƒ©ãƒ¼\n${result ? result.error : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
            }
          })
          .withFailureHandler(function(error) {
            console.error('GASé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
            alert(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n${error.message || error}`);
          })
          .getSpreadsheetUrl();
      } catch (error) {
        console.error('é–¢æ•°å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        alert(`âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼\n${error.message || error}`);
      }
    }

    async function testGeminiConnection() {
      try {
        showLoadingStatus('ğŸ¤– Geminiæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
        
        await google.script.run
          .withSuccessHandler(() => {
            hideLoadingStatus();
            alert('âœ… Geminiæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
          })
          .withFailureHandler((error) => {
            hideLoadingStatus();
            alert(`âŒ Geminiæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—\n${error.message || error}`);
          })
          .testGemini();
          
      } catch (error) {
        hideLoadingStatus();
        handleError(error);
      }
    }

    async function runDebugTests() {
      if (confirm('è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„')) {
        try {
          showLoadingStatus('ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
          
          await google.script.run
            .withSuccessHandler(() => {
              hideLoadingStatus();
              alert('âœ… ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº†\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            })
            .withFailureHandler(handleError)
            .runStepByStepTest();
            
        } catch (error) {
          hideLoadingStatus();
          handleError(error);
        }
      }
    }

    function checkSystemHealth() {
      try {
        showLoadingStatus('ğŸ©º ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ä¸­...');
        
        google.script.run
          .withSuccessHandler(displayHealthResult)
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            handleError(error);
          })
          .performHealthCheck();
          
      } catch (error) {
        hideLoadingStatus();
        handleError(error);
      }
    }

    // AIåˆ†ææ¥ç¶šãƒ†ã‚¹ãƒˆ
    function testAnalysisConnection() {
      try {
        showLoadingStatus('ğŸ§ª AIåˆ†ææ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
        console.log('ğŸ§ª AIåˆ†ææ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ:', result);
            
            if (result === null || result === undefined) {
              alert('âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: GASé–¢æ•°ãŒnullã‚’è¿”ã—ã¾ã—ãŸ\n\nGASãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else if (result.success) {
              alert(`âœ… AIåˆ†ææ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼\n\nè©³ç´°:\n- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${result.message}\n- æ™‚åˆ»: ${result.timestamp}\n- ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${result.gasVersion}`);
            } else {
              alert(`âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}\n\næ™‚åˆ»: ${result.timestamp}`);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('âŒ ãƒ†ã‚¹ãƒˆé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
            alert(`âŒ ãƒ†ã‚¹ãƒˆé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼\n\n${error.message || error}`);
          })
          .testAnalysisConnection('ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆ');
          
      } catch (error) {
        hideLoadingStatus();
        console.error('âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–:', error);
        alert(`âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–\n\n${error.message}`);
      }
    }

    // AnalysisManagerè©³ç´°ãƒ†ã‚¹ãƒˆ
    function testAnalysisManagerDetails() {
      try {
        console.log('ğŸ” AnalysisManagerè©³ç´°ãƒ†ã‚¹ãƒˆé–‹å§‹');
        showLoadingStatus('ğŸ” AnalysisManagerè©³ç´°ãƒ†ã‚¹ãƒˆä¸­...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('ğŸ” è©³ç´°ãƒ†ã‚¹ãƒˆçµæœ:', result);
            
            if (result === null || result === undefined) {
              alert('âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: GASé–¢æ•°ãŒnullã‚’è¿”ã—ã¾ã—ãŸ\n\nGASãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else if (result.error) {
              alert(`âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${result.error}\n\n${result.summary}`);
            } else {
              let message = `ğŸ” AnalysisManagerè©³ç´°ãƒ†ã‚¹ãƒˆçµæœ\n\n`;
              message += `ã‚µãƒãƒªãƒ¼: ${result.summary}\n\n`;
              
              if (result.tests) {
                message += `ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœ:\n`;
                message += `- AnalysisManagerå­˜åœ¨: ${result.tests.analysisManagerExists ? 'âœ…' : 'âŒ'}\n`;
                message += `- createMethodExists: ${result.tests.createMethodExists ? 'âœ…' : 'âŒ'}\n`;
                
                if (result.tests.dependencies) {
                  message += `\nğŸ”§ ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«:\n`;
                  Object.entries(result.tests.dependencies).forEach(([dep, exists]) => {
                    message += `- ${dep}: ${exists ? 'âœ…' : 'âŒ'}\n`;
                  });
                }
                
                if (result.tests.sessionCreation) {
                  message += `\nğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ†ã‚¹ãƒˆ:\n`;
                  message += `- æˆåŠŸ: ${result.tests.sessionCreation.success ? 'âœ…' : 'âŒ'}\n`;
                  message += `- sessionId: ${result.tests.sessionCreation.hasSessionId ? 'âœ…' : 'âŒ'}\n`;
                  message += `- fileIds: ${result.tests.sessionCreation.hasFileIds ? 'âœ…' : 'âŒ'}\n`;
                }
              }
              
              if (result.errors && result.errors.length > 0) {
                message += `\nâŒ ã‚¨ãƒ©ãƒ¼:\n${result.errors.join('\n')}`;
              }
              
              alert(message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('âŒ è©³ç´°ãƒ†ã‚¹ãƒˆé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
            alert(`âŒ è©³ç´°ãƒ†ã‚¹ãƒˆé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼\n\n${error.message || error}`);
          })
          .testAnalysisManagerDetails();
          
      } catch (error) {
        hideLoadingStatus();
        console.error('âŒ è©³ç´°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–:', error);
        alert(`âŒ è©³ç´°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–\n\n${error.message}`);
      }
    }

    // æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆé–¢æ•°
    function testSearchStats() {
      try {
        console.log('ğŸ“Š æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆé–‹å§‹');
        showLoadingStatus('ğŸ“Š æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆä¸­...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('ğŸ“Š æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆçµæœ:', result);
            
            if (result && result.success) {
              alert(`âœ… æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼\n\n` +
                   `ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒª: "${result.testQuery}"\n` +
                   `æ¤œç´¢çµæœæ•°: ${result.searchResults}ä»¶\n` +
                   `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${result.message}\n\n` +
                   `GASãƒ­ã‚°ã‚’ç¢ºèªã—ã¦çµ±è¨ˆè¨˜éŒ²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            } else {
              alert(`âŒ æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆå¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ${result ? result.error : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('âŒ æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            alert(`âŒ æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼\n\n${error.message || error}`);
          })
          .testSearchWithStats('çµ±è¨ˆãƒ†ã‚¹ãƒˆæ¤œç´¢');
          
      } catch (error) {
        hideLoadingStatus();
        console.error('âŒ æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–:', error);
        alert(`âŒ æ¤œç´¢çµ±è¨ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–\n\n${error.message}`);
      }
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå˜ä½“ãƒ†ã‚¹ãƒˆ
    function testCreateAnalysisSessionUnit() {
      try {
        console.log('âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå˜ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹');
        showLoadingStatus('âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå˜ä½“ãƒ†ã‚¹ãƒˆä¸­...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoadingStatus();
            console.log('âš™ï¸ å˜ä½“ãƒ†ã‚¹ãƒˆçµæœ:', result);
            
            if (result === null || result === undefined) {
              alert('âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: GASé–¢æ•°ãŒnullã‚’è¿”ã—ã¾ã—ãŸ\n\nGASãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else if (result.error) {
              alert(`âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${result.error}\n\n${result.summary}`);
            } else {
              let message = `âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå˜ä½“ãƒ†ã‚¹ãƒˆçµæœ\n\n`;
              message += `ã‚µãƒãƒªãƒ¼: ${result.summary}\n\n`;
              
              if (result.results) {
                message += `ğŸ“‹ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹çµæœ:\n`;
                result.results.forEach((testCase, index) => {
                  message += `\n${index + 1}. ${testCase.case}:\n`;
                  
                  // ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å ´åˆã¯ç‰¹åˆ¥ãªè¡¨ç¤º
                  if (testCase.case.includes('ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ')) {
                    message += `   ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ${testCase.success ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'}\n`;
                    if (testCase.errorHandling) {
                      message += `   åˆ¤å®š: ${testCase.errorHandling}\n`;
                    }
                    if (testCase.error) {
                      message += `   ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${testCase.error}\n`;
                    }
                  } else {
                    // é€šå¸¸ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
                    message += `   æˆåŠŸ: ${testCase.success ? 'âœ…' : 'âŒ'}\n`;
                    
                    if (testCase.hasSessionId !== undefined) {
                      message += `   sessionId: ${testCase.hasSessionId ? 'âœ…' : 'âŒ'}\n`;
                    }
                    if (testCase.isMultiFile !== undefined) {
                      message += `   ãƒãƒ«ãƒãƒ•ã‚¡ã‚¤ãƒ«: ${testCase.isMultiFile ? 'âœ…' : 'âŒ'}\n`;
                    }
                  }
                  
                  if (testCase.isErrorResponse !== undefined && !testCase.case.includes('ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ')) {
                    message += `   ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${testCase.isErrorResponse ? 'âœ…' : 'âŒ'}\n`;
                  }
                });
              }
              
              alert(message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoadingStatus();
            console.error('âŒ å˜ä½“ãƒ†ã‚¹ãƒˆé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
            alert(`âŒ å˜ä½“ãƒ†ã‚¹ãƒˆé–¢æ•°å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼\n\n${error.message || error}`);
          })
          .testCreateAnalysisSessionUnit();
          
      } catch (error) {
        hideLoadingStatus();
        console.error('âŒ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–:', error);
        alert(`âŒ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¾‹å¤–\n\n${error.message}`);
      }
    }

    function displayHealthResult(result) {
      hideLoadingStatus();
      
      if (result.success) {
        const health = result.health;
        const statusIcon = health.overall === 'healthy' ? 'âœ…' : 
                          health.overall === 'warning' ? 'âš ï¸' : 'âŒ';
        
        let message = `${statusIcon} ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§: ${health.overall}\n\n`;
        
        if (health.issues.length > 0) {
          message += `å•é¡Œ:\n${health.issues.join('\n')}\n\n`;
        }
        
        if (health.recommendations.length > 0) {
          message += `æ¨å¥¨äº‹é …:\n${health.recommendations.join('\n')}`;
        }
        
        alert(message);
      } else {
        alert(`âŒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼\n${result.error}`);
      }
    }


    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function showLoadingStatus(message) {
      document.getElementById('results').innerHTML = `<div class="loading">${message}</div>`;
    }

    function hideLoadingStatus() {
      // ä½•ã‚‚ã—ãªã„ï¼ˆæ¬¡ã®å‡¦ç†ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
    }

    function handleError(error) {
      hideLoadingStatus();
      console.error('ã‚¨ãƒ©ãƒ¼:', error);
      alert(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n${error.message || error}`);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // ç°¡æ˜“é€šçŸ¥
        const originalText = event.target.textContent;
        event.target.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
        setTimeout(() => {
          event.target.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
      });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆAIåˆ†æç”¨ï¼‰
    let currentAnalysisSession = null;
    let analysisQuestionCounter = 0;
    let isAnalysisProcessing = false;

    // ãƒ•ã‚¡ã‚¤ãƒ«è§£ææ©Ÿèƒ½ï¼ˆçµ±åˆç‰ˆï¼‰
    function analyzeFile(fileId, fileName) {
      if (!fileId) {
        alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«IDãŒç„¡åŠ¹ã§ã™');
        return;
      }
      
      console.log(`ğŸ”¬ ãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹: ${fileName} (${fileId})`);
      
      try {
        // åˆ†æã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        showAnalysisArea(fileId, fileName);
        
        // åˆ†æã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã¨å‡¦ç†é–‹å§‹
        startAnalysisSession(fileId, fileName);
        
        // æˆåŠŸé€šçŸ¥
        const originalText = event.target.textContent;
        event.target.textContent = 'âœ… åˆ†æã‚¨ãƒªã‚¢ã‚’é–‹ãã¾ã—ãŸ';
        setTimeout(() => {
          event.target.textContent = originalText;
        }, 3000);
        
        // åˆ†æã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('analysisContainer').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
        
      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
        alert(`âŒ è§£æé–‹å§‹ã‚¨ãƒ©ãƒ¼\n${error.message}`);
      }
    }

    // åˆ†æã‚¨ãƒªã‚¢è¡¨ç¤º
    function showAnalysisArea(fileId, fileName) {
      const analysisContainer = document.getElementById('analysisContainer');
      const analysisFileName = document.getElementById('analysisFileName');
      
      analysisContainer.style.display = 'block';
      analysisFileName.textContent = `ğŸ“„ ${fileName}`;
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
      currentAnalysisSession = null;
      analysisQuestionCounter = 0;
      isAnalysisProcessing = false;
      
      // è³ªå•ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ã¾ã§ï¼‰
      document.getElementById('analysisAskBtn').disabled = true;
      
      // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
      const chatMessages = document.getElementById('analysisChatMessages');
      chatMessages.innerHTML = `
        <div class="chat-message assistant">
          <div class="message-header">ğŸ¤– Gemini AI</div>
          <div class="message-content">
            ã€Œ${fileName}ã€ã®è§£æã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...<br>
            ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†ã¾ã§å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚
          </div>
        </div>
      `;
      
      updateAnalysisStatus('è§£ææº–å‚™ä¸­...');
      
      console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: åˆ†æã‚¨ãƒªã‚¢è¡¨ç¤ºå®Œäº†');
      console.log('ğŸ”§ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:', { fileId, fileName });
    }

    // åˆ†æã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹
    function closeAnalysis() {
      document.getElementById('analysisContainer').style.display = 'none';
      currentAnalysisSession = null;
      analysisQuestionCounter = 0;
      isAnalysisProcessing = false;
    }

    // åˆ†æã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
    function startAnalysisSession(fileId, fileName) {
      try {
        isAnalysisProcessing = true;
        updateAnalysisStatus('è§£æã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¸­...');
        
        console.log(`ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆé–‹å§‹ - ãƒ•ã‚¡ã‚¤ãƒ«ID: ${fileId}`);
        
        // GASé–¢æ•°å‘¼ã³å‡ºã—: è§£æã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
            console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ—:', typeof result);
            console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: sessionIdå­˜åœ¨:', !!(result && result.sessionId));
            console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: successå€¤:', result ? result.success : 'undefined');
            
            // nullã¾ãŸã¯undefinedãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆ
            if (result === null || result === undefined) {
              console.error('âŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒnull/undefinedã§ã™');
              updateAnalysisStatus('âŒ GASé–¢æ•°ã‹ã‚‰nullãƒ¬ã‚¹ãƒãƒ³ã‚¹');
              addAnalysisMessage('assistant', 'âŒ GASé–¢æ•°ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚GASãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
              isAnalysisProcessing = false;
              return;
            }
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆ
            if (result && result.success === false) {
              console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå¤±æ•—:', result.error);
              console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', result.details);
              updateAnalysisStatus(`âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼: ${result.error}`);
              addAnalysisMessage('assistant', `âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼: ${result.error}`);
              isAnalysisProcessing = false;
              return;
            }
            
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ è©³ç´°ãƒ­ã‚°
            console.log('ğŸ”§ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°åˆ†æ:');
            console.log('  - result:', result);
            console.log('  - typeof result:', typeof result);
            console.log('  - result.sessionId:', result ? result.sessionId : 'N/A');
            console.log('  - result.fileIds:', result ? result.fileIds : 'N/A');
            console.log('  - result.success:', result ? result.success : 'N/A');
            console.log('  - Object.keys(result):', result ? Object.keys(result) : 'N/A');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒå­˜åœ¨ã™ã‚Œã°å‡¦ç†ã‚’ç¶šè¡Œï¼ˆfileIdsãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œï¼‰
            if (result && result.sessionId) {
              currentAnalysisSession = result;
              console.log('âœ… è§£æã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†:', currentAnalysisSession.sessionId);
              updateAnalysisStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå®Œäº† - ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ä¸­...');
              addAnalysisMessage('assistant', `âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†: ${result.sessionId.substring(0, 12)}`);
              prepareFileAnalysis(fileId);
            } else {
              console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', result);
              console.error('æœŸå¾…ã•ã‚Œã‚‹æ§‹é€ : {sessionId, ...}');
              updateAnalysisStatus('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã§ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ');
              addAnalysisMessage('assistant', `âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãªã—: ${JSON.stringify(result)}`);
              isAnalysisProcessing = false;
            }
          })
          .withFailureHandler(function(error) {
            console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆGASã‚¨ãƒ©ãƒ¼:', error);
            updateAnalysisStatus(`âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
            addAnalysisMessage('assistant', `âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
            isAnalysisProcessing = false;
          })
          .createAnalysisSession(fileId);
          
      } catch (error) {
        console.error('âŒ è§£æã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¾‹å¤–:', error);
        updateAnalysisStatus(`âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¾‹å¤–: ${error.message}`);
        addAnalysisMessage('assistant', `âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¾‹å¤–: ${error.message}`);
        isAnalysisProcessing = false;
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™
    function prepareFileAnalysis(fileId) {
      try {
        updateAnalysisStatus('ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™ä¸­...');
        console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™é–‹å§‹');
        console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±:', currentAnalysisSession);
        
        // GASé–¢æ•°å‘¼ã³å‡ºã—: ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆ
            if (result && result.success === false) {
              console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å¤±æ•—:', result.error);
              updateAnalysisStatus(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ã‚¨ãƒ©ãƒ¼: ${result.error}`);
              addAnalysisMessage('assistant', `âŒ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ã‚¨ãƒ©ãƒ¼: ${result.error}`);
              isAnalysisProcessing = false;
              return;
            }
            
            // æ­£å¸¸å®Œäº†ã®å ´åˆ
            console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™å®Œäº†');
            updateAnalysisStatus('âœ… æº–å‚™å®Œäº† - è³ªå•ã‚’ã©ã†ãï¼');
            addAnalysisMessage('assistant', 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™å®Œäº†ï¼ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚');
            isAnalysisProcessing = false;
            
            // è³ªå•å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('analysisAskBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™GASã‚¨ãƒ©ãƒ¼:', error);
            updateAnalysisStatus(`âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
            addAnalysisMessage('assistant', `âŒ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
            isAnalysisProcessing = false;
          })
          .prepareFileForAnalysis(currentAnalysisSession);
          
      } catch (error) {
        console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£ææº–å‚™ä¾‹å¤–:', error);
        updateAnalysisStatus(`âŒ æº–å‚™ä¾‹å¤–: ${error.message}`);
        addAnalysisMessage('assistant', `âŒ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ä¾‹å¤–: ${error.message}`);
        isAnalysisProcessing = false;
      }
    }

    // è³ªå•ä¾‹ã‚’ã‚»ãƒƒãƒˆ
    function setAnalysisQuestion(question) {
      document.getElementById('analysisQuestionInput').value = question;
    }

    // AIè³ªå•å‡¦ç†
    async function askAnalysisQuestion() {
      const questionInput = document.getElementById('analysisQuestionInput');
      const question = questionInput.value.trim();
      
      if (!question) {
        alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ãƒ‡ãƒãƒƒã‚°: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
      console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: è³ªå•å‡¦ç†é–‹å§‹');
      console.log('ğŸ”§ currentAnalysisSession:', currentAnalysisSession);
      console.log('ğŸ”§ isAnalysisProcessing:', isAnalysisProcessing);
      
      if (!currentAnalysisSession) {
        const errorMsg = `åˆ†æã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
        
ãƒ‡ãƒãƒƒã‚°æƒ…å ±:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ: ${currentAnalysisSession}
- å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°: ${isAnalysisProcessing}
        
ã€ŒğŸ”¬ AIè§£æã€ãƒœã‚¿ãƒ³ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`;
        
        alert(errorMsg);
        updateAnalysisStatus('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æœªé–‹å§‹ - å†åº¦AIè§£æãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
        return;
      }
      
      if (isAnalysisProcessing) {
        alert('å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      try {
        isAnalysisProcessing = true;
        questionInput.value = '';
        document.getElementById('analysisAskBtn').disabled = true;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        addAnalysisMessage('user', question);
        
        // ã€Œå›ç­”ç”Ÿæˆä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const loadingMessageId = addAnalysisMessage('assistant', 'å›ç­”ã‚’ç”Ÿæˆä¸­...', true);
        
        updateAnalysisStatus('AIå›ç­”ç”Ÿæˆä¸­...');
        
        // å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        showFullScreenLoading('AIå›ç­”ç”Ÿæˆä¸­...', 'Geminiã§è³ªå•ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™ï¼ˆé€šå¸¸10-15ç§’ï¼‰', 'è³ªå•é€ä¿¡å®Œäº†');
        
        // å®Ÿéš›ã®Gemini APIå‘¼ã³å‡ºã—
        google.script.run
          .withSuccessHandler(function(response) {
            console.log('ğŸ”§ è³ªå•ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response);
            console.log('ğŸ”§ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹:', typeof response);
            console.log('ğŸ”§ successå€¤:', response?.success);
            
            // å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            hideFullScreenLoading();
            
            removeAnalysisMessage(loadingMessageId);
            
            // null/undefined ãƒã‚§ãƒƒã‚¯
            if (response === null || response === undefined) {
              addAnalysisMessage('assistant', 'âŒ GASé–¢æ•°ã‹ã‚‰ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
              updateAnalysisStatus('âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼');
              isAnalysisProcessing = false;
              document.getElementById('analysisAskBtn').disabled = false;
              return;
            }
            
            if (response.success) {
              console.log('ğŸ”§ æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ - å›ç­”è¡¨ç¤º');
              addAnalysisMessage('assistant', response.response);
              analysisQuestionCounter++;
              updateAnalysisStatus('âœ… æº–å‚™å®Œäº† - è³ªå•ã‚’ã©ã†ãï¼');
              
              // åˆ‡ã‚Šè©°ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
              if (response.truncated) {
                addAnalysisMessage('assistant', 'ğŸ’¡ å›ç­”ãŒé•·ã„ãŸã‚çœç•¥ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ãªåˆ†æçµæœã¯å±¥æ­´æ©Ÿèƒ½ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚');
              }
            } else {
              console.log('ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.error);
              addAnalysisMessage('assistant', `âŒ ã‚¨ãƒ©ãƒ¼: ${response.error}`);
              updateAnalysisStatus('âŒ è³ªå•å‡¦ç†ã‚¨ãƒ©ãƒ¼');
            }
            
            isAnalysisProcessing = false;
            document.getElementById('analysisAskBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            // å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            hideFullScreenLoading();
            
            removeAnalysisMessage(loadingMessageId);
            addAnalysisMessage('assistant', `âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
            
            updateAnalysisStatus('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            isAnalysisProcessing = false;
            document.getElementById('analysisAskBtn').disabled = false;
          })
          .processAnalysisQuestion(currentAnalysisSession, question);

      } catch (error) {
        // å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        hideFullScreenLoading();
        
        console.error('è³ªå•å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        updateAnalysisStatus(`âŒ è³ªå•å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        isAnalysisProcessing = false;
        document.getElementById('analysisAskBtn').disabled = false;
      }
    }

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
    function addAnalysisMessage(type, content, isLoading = false) {
      const chatMessages = document.getElementById('analysisChatMessages');
      const messageId = 'analysis_msg_' + Date.now();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}`;
      messageDiv.id = messageId;
      
      const header = type === 'user' ? 'ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'ğŸ¤– Gemini AI';
      
      // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è§£æï¼ˆAIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼‰
      let processedContent = content;
      if (type === 'assistant' && !isLoading && typeof marked !== 'undefined') {
        try {
          // XSSæ”»æ’ƒé˜²æ­¢ã®ãŸã‚ã®è¨­å®š
          marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            smartLists: true,
            smartypants: false
          });
          
          processedContent = marked.parse(content);
          console.log('ğŸ¨ ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è§£æå®Œäº†');
        } catch (error) {
          console.warn('âš ï¸ ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è§£æã‚¨ãƒ©ãƒ¼:', error);
          processedContent = content; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
      }
      
      messageDiv.innerHTML = `
        <div class="message-header">${header}</div>
        <div class="message-content">${processedContent}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageId;
    }

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
    function removeAnalysisMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateAnalysisStatus(status) {
      document.getElementById('analysisStatus').textContent = status || 'æº–å‚™å®Œäº†';
    }

    // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§è³ªå•é€ä¿¡
    document.addEventListener('DOMContentLoaded', function() {
      const questionInput = document.getElementById('analysisQuestionInput');
      if (questionInput) {
        questionInput.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            askAnalysisQuestion();
          }
        });
      }
    });

    // å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡é–¢æ•°
    function showFullScreenLoading(text = 'AIå‡¦ç†ä¸­...', subtext = 'å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', progress = 'å‡¦ç†é–‹å§‹') {
      const loadingElement = document.getElementById('fullScreenLoading');
      const loadingText = document.getElementById('loadingText');
      const loadingSubtext = document.getElementById('loadingSubtext');
      const loadingProgress = document.getElementById('loadingProgress');
      
      if (loadingElement) {
        loadingText.textContent = text;
        loadingSubtext.textContent = subtext;
        loadingProgress.textContent = progress;
        loadingElement.classList.remove('hidden');
        
        // ãƒœãƒ‡ã‚£ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
        document.body.style.overflow = 'hidden';
        
        console.log('ğŸ”„ å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º:', text);
      }
    }
    
    function hideFullScreenLoading() {
      const loadingElement = document.getElementById('fullScreenLoading');
      
      if (loadingElement) {
        loadingElement.classList.add('hidden');
        
        // ãƒœãƒ‡ã‚£ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        document.body.style.overflow = '';
        
        console.log('âœ… å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º');
      }
    }
    
    function updateFullScreenLoadingProgress(progress) {
      const loadingProgress = document.getElementById('loadingProgress');
      if (loadingProgress) {
        loadingProgress.textContent = progress;
        console.log('ğŸ“Š ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é€²æ—æ›´æ–°:', progress);
      }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
      // Ctrl+Enter ã§æ¤œç´¢
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        performSearch();
      }
    });
  </script>
</body>
</html>