<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()">
  <title>ğŸ”¬ AIè§£æãƒ»ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ - ãƒ‡ã‚¶ã‚¤ãƒ³äº‹å‹™æ‰€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  v2.0</title>
  <style>
    /* æ—¢å­˜ã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’è¸è¥² */
    :root {
      --primary-khaki: #8B9A5B;
      --light-khaki: #A8B373;
      --pale-khaki: #C5D197;
      --cream-khaki: #F5F7F0;
      --dark-khaki: #6B7A47;
      --accent-khaki: #9CAD6B;
      --shadow-khaki: rgba(139, 154, 91, 0.2);
      --chat-user: #e3f2fd;
      --chat-assistant: #f3e5f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      background: linear-gradient(135deg, var(--pale-khaki) 0%, var(--cream-khaki) 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .header {
      text-align: center;
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px var(--shadow-khaki);
      margin-bottom: 24px;
      border-left: 6px solid var(--primary-khaki);
    }
    
    .header h1 {
      margin: 0 0 12px 0;
      color: var(--primary-khaki);
      font-size: clamp(20px, 4vw, 28px);
      font-weight: 700;
    }

    .navigation {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 10px 20px;
      background: var(--light-khaki);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: var(--primary-khaki);
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: var(--dark-khaki);
    }
    
    .main-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
      height: calc(100vh - 200px);
      min-height: 600px;
    }
    
    .file-panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      padding: 16px 20px;
      font-weight: 600;
      font-size: 16px;
    }
    
    .file-content, .chat-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ */
    .file-selector {
      border: 2px dashed var(--pale-khaki);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    
    .file-selector.dragover {
      border-color: var(--primary-khaki);
      background: var(--cream-khaki);
    }
    
    .file-selector input[type="file"] {
      display: none;
    }
    
    .file-selector-btn {
      background: var(--primary-khaki);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 8px;
    }
    
    .file-selector-btn:hover {
      background: var(--dark-khaki);
    }
    
    /* æ¤œç´¢çµ±åˆãƒœã‚¿ãƒ³ */
    .search-integration {
      background: var(--cream-khaki);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid var(--pale-khaki);
    }
    
    .search-integration h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: 14px;
    }
    
    .search-btn {
      background: var(--light-khaki);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    /* é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º */
    .selected-files {
      margin-top: 20px;
    }
    
    .file-item {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid var(--primary-khaki);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      color: var(--dark-khaki);
      font-size: 14px;
    }
    
    .file-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
    }
    
    .file-action-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-analyze {
      background: var(--primary-khaki);
      color: white;
    }
    
    .btn-remove {
      background: #ff6b6b;
      color: white;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      max-height: 400px;
    }
    
    .message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .message.user {
      background: var(--chat-user);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .message.assistant {
      background: var(--chat-assistant);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    
    .message-header {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .message-content {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      text-align: right;
    }
    
    /* è³ªå•å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .question-input-area {
      border-top: 1px solid var(--pale-khaki);
      padding: 20px;
      background: var(--cream-khaki);
    }
    
    .question-examples {
      margin-bottom: 16px;
    }
    
    .question-examples h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: var(--dark-khaki);
    }
    
    .example-questions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .example-question {
      background: white;
      color: var(--primary-khaki);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--pale-khaki);
      transition: all 0.2s ease;
    }
    
    .example-question:hover {
      background: var(--primary-khaki);
      color: white;
    }
    
    .question-input {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    
    .question-textarea {
      flex: 1;
      min-height: 40px;
      max-height: 120px;
      padding: 12px;
      border: 2px solid var(--pale-khaki);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      background: white;
    }
    
    .question-textarea:focus {
      outline: none;
      border-color: var(--primary-khaki);
      box-shadow: 0 0 0 2px var(--shadow-khaki);
    }
    
    .ask-btn {
      padding: 12px 20px;
      background: var(--primary-khaki);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .ask-btn:hover {
      background: var(--dark-khaki);
    }
    
    .ask-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    .status-area {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-top: 1px solid var(--pale-khaki);
      font-size: 13px;
      color: var(--dark-khaki);
    }
    
    .status-item {
      display: inline-block;
      margin-right: 16px;
    }
    
    .status-value {
      font-weight: 600;
      color: var(--primary-khaki);
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .loading::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--pale-khaki);
      border-top: 2px solid var(--primary-khaki);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .file-panel {
        order: 1;
        max-height: 300px;
      }
      
      .chat-panel {
        order: 2;
        min-height: 500px;
      }
      
      .question-input {
        flex-direction: column;
        align-items: stretch;
      }
      
      .ask-btn {
        margin-top: 8px;
      }
    }
    
    /* æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”¬ ãƒ•ã‚¡ã‚¤ãƒ«è§£æãƒ»ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½</h1>
    <p>ç”»åƒãƒ»PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’Gemini AIã§è©³ç´°è§£æã—ã€è³ªå•å¿œç­”ã§ãã¾ã™</p>
    
    <div class="navigation">
      <a href="javascript:goToSearchPage()" class="nav-btn">ğŸ” æ¤œç´¢æ©Ÿèƒ½</a>
      <a href="javascript:void(0)" class="nav-btn active">ğŸ”¬ ãƒ•ã‚¡ã‚¤ãƒ«è§£æ</a>
    </div>
  </div>

  <div class="main-container">
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ‘ãƒãƒ« -->
    <div class="file-panel">
      <div class="panel-header">
        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ç®¡ç†
      </div>
      
      <div class="file-content">
        <!-- æ¤œç´¢çµ±åˆ -->
        <div class="search-integration">
          <h4>ğŸ” æ¤œç´¢çµæœã‹ã‚‰é¸æŠ</h4>
          <button class="search-btn" onclick="openSearchResults()">æ¤œç´¢çµæœã‚’è¡¨ç¤º</button>
          <button class="search-btn" onclick="importFromUrl()">URLã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
        <div class="file-selector" id="fileSelector">
          <div>
            <p>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p>ã¾ãŸã¯</p>
            <button class="file-selector-btn" onclick="document.getElementById('fileInput').click()">
              ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </button>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf" onchange="handleFileSelect(event)">
          </div>
          <div style="margin-top: 12px; font-size: 12px; color: #666;">
            å¯¾å¿œå½¢å¼: JPEG, PNG, GIF, WebP, PDF<br>
            æœ€å¤§ã‚µã‚¤ã‚º: 20MB<br>
            æœ€å¤§åŒæ™‚: 16ãƒ•ã‚¡ã‚¤ãƒ«
          </div>
        </div>
        
        <!-- é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« -->
        <div class="selected-files" id="selectedFiles">
          <h4>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h4>
          <div id="fileList">
            <p style="color: #666; font-size: 14px;">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ãƒãƒ£ãƒƒãƒˆãƒ»è§£æãƒ‘ãƒãƒ« -->
    <div class="chat-panel">
      <div class="panel-header">
        ğŸ’¬ AIè§£æãƒ»è³ªå•å¿œç­”
      </div>
      
      <div class="chat-content">
        <div id="alertArea"></div>
        
        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-header">ğŸ¤– Gemini AI</div>
            <div class="message-content">
              ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦è§£æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚<br>
              ç”»åƒã‚„å›³é¢ã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ã„ãŸã ã‘ã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>
      
      <div class="question-input-area">
        <div class="question-examples">
          <h4>ğŸ’¡ è³ªå•ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ï¼‰</h4>
          <div class="example-questions">
            <span class="example-question" onclick="setQuestion('ã“ã®å›³é¢ã®æ¦‚è¦ã‚’æ•™ãˆã¦ãã ã•ã„')">å›³é¢ã®æ¦‚è¦</span>
            <span class="example-question" onclick="setQuestion('å¯¸æ³•ã‚„ä»•æ§˜ã®è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„')">å¯¸æ³•ãƒ»ä»•æ§˜</span>
            <span class="example-question" onclick="setQuestion('ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç‰¹å¾´ã‚’åˆ†æã—ã¦ãã ã•ã„')">ãƒ‡ã‚¶ã‚¤ãƒ³åˆ†æ</span>
            <span class="example-question" onclick="setQuestion('å•é¡Œç‚¹ã‚„æ”¹å–„ææ¡ˆã¯ã‚ã‚Šã¾ã™ã‹')">æ”¹å–„ææ¡ˆ</span>
            <span class="example-question" onclick="setQuestion('é¡ä¼¼ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™')">ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒ‰ãƒã‚¤ã‚¹</span>
            <span class="example-question" onclick="setQuestion('ã“ã®å»ºç‰©ã®ç”¨é€”ã‚„æ©Ÿèƒ½ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')">ç”¨é€”ãƒ»æ©Ÿèƒ½</span>
          </div>
        </div>
        
        <div class="question-input">
          <textarea 
            id="questionTextarea" 
            class="question-textarea" 
            placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„..."
            onkeydown="handleQuestionKeyDown(event)"
            disabled
          ></textarea>
          <button id="askBtn" class="ask-btn" onclick="askQuestion()" disabled>
            é€ä¿¡
          </button>
        </div>
      </div>
      
      <div class="status-area" id="statusArea">
        <span class="status-item">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span class="status-value" id="currentStatus">å¾…æ©Ÿä¸­</span></span>
        <span class="status-item">é¸æŠãƒ•ã‚¡ã‚¤ãƒ«: <span class="status-value" id="fileCount">0</span>ä»¶</span>
        <span class="status-item">è³ªå•æ•°: <span class="status-value" id="questionCount">0</span>ä»¶</span>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentAnalysisSession = null;
    let selectedFiles = [];
    let questionCounter = 0;
    let isProcessing = false;

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    window.addEventListener('error', function(e) {
      console.error('JavaScript ã‚¨ãƒ©ãƒ¼:', e.error);
      console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.message, 'at', e.filename, ':', e.lineno);
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('load', function() {
      try {
        console.log('ğŸ”¬ ãƒ•ã‚¡ã‚¤ãƒ«è§£æãƒ»ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ èµ·å‹•');
        setupFileDropArea();
        checkForImportedFile();
        updateStatus();
        
        // åˆæœŸè¡¨ç¤ºç¢ºèª
        console.log('âœ… åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        document.body.innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <h1 style="color: red;">âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h1>
            <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
            <p>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
          </div>
        `;
      }
    });

    // æ¤œç´¢ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
    function goToSearchPage() {
      const currentUrl = window.location.origin + window.location.pathname;
      const searchUrl = currentUrl + '?page=search';
      window.location.href = searchUrl;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®è¨­å®š
    function setupFileDropArea() {
      const fileSelector = document.getElementById('fileSelector');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileSelector.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        fileSelector.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        fileSelector.addEventListener(eventName, unhighlight, false);
      });
      
      fileSelector.addEventListener('drop', handleDrop, false);
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function highlight(e) {
      document.getElementById('fileSelector').classList.add('dragover');
    }

    function unhighlight(e) {
      document.getElementById('fileSelector').classList.remove('dragover');
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
    function handleFileSelect(event) {
      const files = event.target.files;
      handleFiles(files);
    }

    function handleFiles(files) {
      const limits = {
        maxFiles: 16,
        maxFileSize: 20 * 1024 * 1024,
        supportedTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf']
      };

      Array.from(files).forEach(file => {
        // åˆ¶é™ãƒã‚§ãƒƒã‚¯
        if (selectedFiles.length >= limits.maxFiles) {
          showAlert('error', `æœ€å¤§${limits.maxFiles}ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§é¸æŠã§ãã¾ã™`);
          return;
        }

        if (file.size > limits.maxFileSize) {
          showAlert('error', `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™: ${file.name} (æœ€å¤§20MB)`);
          return;
        }

        if (!limits.supportedTypes.includes(file.type)) {
          showAlert('error', `ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${file.name}`);
          return;
        }

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
          showAlert('warning', `æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã¾ã™: ${file.name}`);
          return;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 
        const fileInfo = {
          file: file,
          name: file.name,
          size: file.size,
          type: file.type,
          id: generateFileId(),
          status: 'selected'
        };

        selectedFiles.push(fileInfo);
      });

      updateFileList();
      updateStatus();
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºæ›´æ–°
    function updateFileList() {
      const fileList = document.getElementById('fileList');
      
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '<p style="color: #666; font-size: 14px;">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
      }

      const html = selectedFiles.map((fileInfo, index) => `
        <div class="file-item" data-file-id="${fileInfo.id}">
          <div class="file-info">
            <div class="file-name">ğŸ“„ ${fileInfo.name}</div>
            <div class="file-meta">
              ${formatFileSize(fileInfo.size)} â€¢ ${fileInfo.type} â€¢ ${fileInfo.status}
            </div>
          </div>
          <div class="file-actions">
            <button class="file-action-btn btn-analyze" onclick="analyzeFile(${index})" 
                    ${fileInfo.status === 'analyzing' ? 'disabled' : ''}>
              ${fileInfo.status === 'analyzing' ? 'è§£æä¸­...' : 'è§£æ'}
            </button>
            <button class="file-action-btn btn-remove" onclick="removeFile(${index})">
              å‰Šé™¤
            </button>
          </div>
        </div>
      `).join('');

      fileList.innerHTML = html;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹
    async function analyzeFile(fileIndex) {
      if (isProcessing) {
        showAlert('warning', 'å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      const fileInfo = selectedFiles[fileIndex];
      if (!fileInfo) return;

      try {
        isProcessing = true;
        fileInfo.status = 'analyzing';
        updateFileList();
        updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«è§£æä¸­...');

        // Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ãªå ´åˆã®å‡¦ç†
        // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚çš„ã«Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€
        // åˆ¥ã®æ–¹æ³•ã§Gemini File APIã«æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™
        
        showAlert('warning', 'ãƒ•ã‚¡ã‚¤ãƒ«è§£ææ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚Google DriveçµŒç”±ã§ã®è§£æãŒå¿…è¦ã§ã™ã€‚');
        
        // é–‹ç™ºç”¨ã®ç–‘ä¼¼å‡¦ç†
        setTimeout(() => {
          fileInfo.status = 'ready';
          updateFileList();
          updateStatus();
          isProcessing = false;
          
          // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
          enableChatInterface();
          
          addMessage('assistant', `ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileInfo.name}ã€ã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä½•ã‹è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ`);
        }, 2000);

      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚¨ãƒ©ãƒ¼:', error);
        showAlert('error', `è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
        fileInfo.status = 'error';
        updateFileList();
        isProcessing = false;
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    function removeFile(fileIndex) {
      selectedFiles.splice(fileIndex, 1);
      updateFileList();
      updateStatus();
      
      if (selectedFiles.length === 0) {
        disableChatInterface();
        clearChat();
      }
    }

    // ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åˆ¶å¾¡
    function enableChatInterface() {
      document.getElementById('questionTextarea').disabled = false;
      document.getElementById('askBtn').disabled = false;
    }

    function disableChatInterface() {
      document.getElementById('questionTextarea').disabled = true;
      document.getElementById('askBtn').disabled = true;
    }

    // è³ªå•å‡¦ç†
    async function askQuestion() {
      const textarea = document.getElementById('questionTextarea');
      const question = textarea.value.trim();
      
      if (!question) {
        showAlert('warning', 'è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (isProcessing) {
        showAlert('warning', 'å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      const readyFiles = selectedFiles.filter(f => f.status === 'ready');
      if (readyFiles.length === 0) {
        showAlert('warning', 'è§£ææ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      try {
        isProcessing = true;
        textarea.value = '';
        document.getElementById('askBtn').disabled = true;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        addMessage('user', question);
        
        // ã€Œå›ç­”ç”Ÿæˆä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const loadingMessageId = addMessage('assistant', 'å›ç­”ã‚’ç”Ÿæˆä¸­...', true);
        
        updateStatus('è³ªå•å‡¦ç†ä¸­...');
        
        // å®Ÿéš›ã®Gemini APIå‘¼ã³å‡ºã—
        google.script.run
          .withSuccessHandler(function(response) {
            removeMessage(loadingMessageId);
            
            if (response.success) {
              addMessage('assistant', response.response);
              questionCounter++;
            } else {
              addMessage('assistant', `âŒ ã‚¨ãƒ©ãƒ¼: ${response.error}`);
            }
            
            updateStatus();
            isProcessing = false;
            document.getElementById('askBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            removeMessage(loadingMessageId);
            addMessage('assistant', `âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
            
            updateStatus();
            isProcessing = false;
            document.getElementById('askBtn').disabled = false;
          })
          .processAnalysisQuestion(currentAnalysisSession, question);

      } catch (error) {
        console.error('è³ªå•å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        showAlert('error', `è³ªå•å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        isProcessing = false;
        document.getElementById('askBtn').disabled = false;
      }
    }

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
    function addMessage(type, content, isLoading = false) {
      const chatMessages = document.getElementById('chatMessages');
      const messageId = 'msg_' + Date.now();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.id = messageId;
      
      const icon = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
      const sender = type === 'user' ? 'ã‚ãªãŸ' : 'Gemini AI';
      
      messageDiv.innerHTML = `
        <div class="message-header">${icon} ${sender}</div>
        <div class="message-content">${content}</div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageId;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // ãƒãƒ£ãƒƒãƒˆã‚¯ãƒªã‚¢
    function clearChat() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `
        <div class="message assistant">
          <div class="message-header">ğŸ¤– Gemini AI</div>
          <div class="message-content">
            ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦è§£æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚<br>
            ç”»åƒã‚„å›³é¢ã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ã„ãŸã ã‘ã¾ã™ã€‚
          </div>
        </div>
      `;
      questionCounter = 0;
    }

    // è³ªå•ä¾‹è¨­å®š
    function setQuestion(question) {
      document.getElementById('questionTextarea').value = question;
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    function handleQuestionKeyDown(event) {
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault();
        askQuestion();
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(status = 'å¾…æ©Ÿä¸­') {
      document.getElementById('currentStatus').textContent = status;
      document.getElementById('fileCount').textContent = selectedFiles.length;
      document.getElementById('questionCount').textContent = questionCounter;
    }

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showAlert(type, message) {
      const alertArea = document.getElementById('alertArea');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${type}`;
      alertDiv.textContent = message;
      
      alertArea.appendChild(alertDiv);
      
      // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // æ¤œç´¢çµæœé€£æºï¼ˆå°†æ¥å®Ÿè£…ï¼‰
    function openSearchResults() {
      // æ–°ã—ã„ã‚¿ãƒ–ã§æ¤œç´¢ç”»é¢ã‚’é–‹ã
      window.open('index.html', '_blank');
    }

    function importFromUrl() {
      const url = prompt('Google Driveãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (url) {
        showAlert('warning', 'URL ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
      }
    }

    // æ¤œç´¢çµæœã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    function checkForImportedFile() {
      try {
        const importedFileData = sessionStorage.getItem('analysisFile');
        if (importedFileData) {
          const fileInfo = JSON.parse(importedFileData);
          console.log('ğŸ”— æ¤œç´¢çµæœã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ:', fileInfo);
          
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
          sessionStorage.removeItem('analysisFile');
          
          // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
          importFileFromSearch(fileInfo);
        }
      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ¤œç´¢çµæœã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
    function importFileFromSearch(fileInfo) {
      showAlert('success', `æ¤œç´¢çµæœã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${fileInfo.fileName}`);
      
      // Google Drive ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ‰±ã†ç–‘ä¼¼ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä½œæˆ
      const virtualFileInfo = {
        name: fileInfo.fileName,
        size: 0, // å®Ÿéš›ã®ã‚µã‚¤ã‚ºã¯ä¸æ˜
        type: 'application/pdf', // ä»®ã® MIME ã‚¿ã‚¤ãƒ—
        id: generateFileId(),
        status: 'imported',
        driveFileId: fileInfo.fileId,
        source: 'search'
      };
      
      selectedFiles.push(virtualFileInfo);
      updateFileList();
      updateStatus();
      
      // è‡ªå‹•è§£æã‚’ææ¡ˆ
      setTimeout(() => {
        if (confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileInfo.fileName}ã€ã‚’è§£æã—ã¾ã™ã‹ï¼Ÿ`)) {
          analyzeImportedFile(selectedFiles.length - 1);
        }
      }, 1000);
    }

    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æ
    async function analyzeImportedFile(fileIndex) {
      if (isProcessing) {
        showAlert('warning', 'å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      const fileInfo = selectedFiles[fileIndex];
      if (!fileInfo || !fileInfo.driveFileId) {
        showAlert('error', 'ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ãŒç„¡åŠ¹ã§ã™');
        return;
      }

      try {
        isProcessing = true;
        fileInfo.status = 'analyzing';
        updateFileList();
        updateStatus('Google Drive ãƒ•ã‚¡ã‚¤ãƒ«è§£æä¸­...');

        console.log(`ğŸ“¤ Google Drive ãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹: ${fileInfo.driveFileId}`);

        // Google Apps Script ã®è§£æé–¢æ•°ã‚’å‘¼ã³å‡ºã—
        const result = await google.script.run
          .withSuccessHandler(function(analysisResult) {
            handleAnalysisSuccess(fileIndex, analysisResult);
          })
          .withFailureHandler(function(error) {
            handleAnalysisError(fileIndex, error);
          })
          .createAnalysisSession([fileInfo.driveFileId]);

      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚¨ãƒ©ãƒ¼:', error);
        handleAnalysisError(fileIndex, error);
      }
    }

    // è§£ææˆåŠŸæ™‚ã®å‡¦ç†
    function handleAnalysisSuccess(fileIndex, analysisResult) {
      console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«è§£ææˆåŠŸ:', analysisResult);
      
      const fileInfo = selectedFiles[fileIndex];
      fileInfo.status = 'ready';
      fileInfo.analysisSession = analysisResult;
      
      updateFileList();
      updateStatus();
      isProcessing = false;
      
      // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
      enableChatInterface();
      
      addMessage('assistant', `ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileInfo.name}ã€ã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç”»åƒã®å†…å®¹ã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ï¼`);
      
      showAlert('success', 'è§£æå®Œäº†ï¼è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    }

    // è§£æã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
    function handleAnalysisError(fileIndex, error) {
      console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚¨ãƒ©ãƒ¼:', error);
      
      const fileInfo = selectedFiles[fileIndex];
      fileInfo.status = 'error';
      
      updateFileList();
      updateStatus();
      isProcessing = false;
      
      showAlert('error', `è§£æã‚¨ãƒ©ãƒ¼: ${error.message || error}`);
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function generateFileId() {
      return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function generateMockResponse(question) {
      const responses = {
        'æ¦‚è¦': 'ã“ã®å›³é¢ã¯ä½å®…ã®å¹³é¢å›³ã®ã‚ˆã†ã§ã™ã€‚ãƒªãƒ“ãƒ³ã‚°ã€ã‚­ãƒƒãƒãƒ³ã€å¯å®¤ãŒé…ç½®ã•ã‚Œã¦ãŠã‚Šã€å‹•ç·šãŒåŠ¹ç‡çš„ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚',
        'å¯¸æ³•': 'ä¸»è¦ãªå¯¸æ³•ã¨ã—ã¦ã€ãƒªãƒ“ãƒ³ã‚°ãŒç´„15ç•³ã€ã‚­ãƒƒãƒãƒ³ãŒå¯¾é¢å¼ã§ç´„6ç•³ã®åºƒã•ã«ãªã£ã¦ã„ã¾ã™ã€‚',
        'ãƒ‡ã‚¶ã‚¤ãƒ³': 'ãƒ¢ãƒ€ãƒ³ã§æ©Ÿèƒ½çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ãŒç‰¹å¾´çš„ã§ã™ã€‚ã‚ªãƒ¼ãƒ—ãƒ³ãªé–“å–ã‚Šã§é–‹æ”¾æ„ŸãŒã‚ã‚Šã¾ã™ã€‚',
        'æ”¹å–„': 'åç´ã‚¹ãƒšãƒ¼ã‚¹ã‚’å¢—ã‚„ã™ã“ã¨ã§ã€ã‚ˆã‚Šå®Ÿç”¨çš„ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚',
        'ã‚¢ãƒ‰ãƒã‚¤ã‚¹': 'ã“ã®ç©ºé–“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯å®¶æ—å‘ã‘ã«æœ€é©åŒ–ã•ã‚Œã¦ãŠã‚Šã€ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¨­è¨ˆã§ã™ã€‚'
      };
      
      for (const [key, response] of Object.entries(responses)) {
        if (question.includes(key)) {
          return response;
        }
      }
      
      return `ã€Œ${question}ã€ã«ã¤ã„ã¦è©³ç´°ã«åˆ†æã„ãŸã—ã¾ã™ã€‚ã“ã®ç”»åƒ/å›³é¢ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ç‰¹å¾´ã‚„è¦ç´ ã«ã¤ã„ã¦ã€å»ºç¯‰ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ã®å°‚é–€çš„è¦³ç‚¹ã‹ã‚‰ãŠç­”ãˆã—ã¾ã™ã€‚`;
    }
  </script>
</body>
</html>