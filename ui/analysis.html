<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()">
  <title>üî¨ AIËß£Êûê„Éª„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ - „Éá„Ç∂„Ç§„É≥‰∫ãÂãôÊâÄÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É† v2.0</title>
  <style>
    /* Êó¢Â≠ò„ÅÆ„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà„ÇíË∏èË•≤ */
    :root {
      --primary-khaki: #8B9A5B;
      --light-khaki: #A8B373;
      --pale-khaki: #C5D197;
      --cream-khaki: #F5F7F0;
      --dark-khaki: #6B7A47;
      --accent-khaki: #9CAD6B;
      --shadow-khaki: rgba(139, 154, 91, 0.2);
      --chat-user: #e3f2fd;
      --chat-assistant: #f3e5f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      background: linear-gradient(135deg, var(--pale-khaki) 0%, var(--cream-khaki) 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .header {
      text-align: center;
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px var(--shadow-khaki);
      margin-bottom: 24px;
      border-left: 6px solid var(--primary-khaki);
    }
    
    .header h1 {
      margin: 0 0 12px 0;
      color: var(--primary-khaki);
      font-size: clamp(20px, 4vw, 28px);
      font-weight: 700;
    }

    .navigation {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 10px 20px;
      background: var(--light-khaki);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: var(--primary-khaki);
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: var(--dark-khaki);
    }
    
    .main-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
      height: calc(100vh - 200px);
      min-height: 600px;
    }
    
    .file-panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-khaki);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      background: linear-gradient(135deg, var(--primary-khaki) 0%, var(--dark-khaki) 100%);
      color: white;
      padding: 16px 20px;
      font-weight: 600;
      font-size: 16px;
    }
    
    .file-content, .chat-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    /* „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Ç®„É™„Ç¢ */
    .file-selector {
      border: 2px dashed var(--pale-khaki);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    
    .file-selector.dragover {
      border-color: var(--primary-khaki);
      background: var(--cream-khaki);
    }
    
    .file-selector input[type="file"] {
      display: none;
    }
    
    .file-selector-btn {
      background: var(--primary-khaki);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 8px;
    }
    
    .file-selector-btn:hover {
      background: var(--dark-khaki);
    }
    
    /* Ê§úÁ¥¢Áµ±Âêà„Éú„Çø„É≥ */
    .search-integration {
      background: var(--cream-khaki);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid var(--pale-khaki);
    }
    
    .search-integration h4 {
      margin: 0 0 12px 0;
      color: var(--dark-khaki);
      font-size: 14px;
    }
    
    .search-btn {
      background: var(--light-khaki);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    /* ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´Ë°®Á§∫ */
    .selected-files {
      margin-top: 20px;
    }
    
    .file-item {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid var(--primary-khaki);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      color: var(--dark-khaki);
      font-size: 14px;
    }
    
    .file-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
    }
    
    .file-action-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-analyze {
      background: var(--primary-khaki);
      color: white;
    }
    
    .btn-remove {
      background: #ff6b6b;
      color: white;
    }
    
    /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      max-height: 400px;
    }
    
    .message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .message.user {
      background: var(--chat-user);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .message.assistant {
      background: var(--chat-assistant);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    
    .message-header {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .message-content {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      text-align: right;
    }
    
    /* Ë≥™ÂïèÂÖ•Âäõ„Ç®„É™„Ç¢ */
    .question-input-area {
      border-top: 1px solid var(--pale-khaki);
      padding: 20px;
      background: var(--cream-khaki);
    }
    
    .question-examples {
      margin-bottom: 16px;
    }
    
    .question-examples h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: var(--dark-khaki);
    }
    
    .example-questions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .example-question {
      background: white;
      color: var(--primary-khaki);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--pale-khaki);
      transition: all 0.2s ease;
    }
    
    .example-question:hover {
      background: var(--primary-khaki);
      color: white;
    }
    
    .question-input {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    
    .question-textarea {
      flex: 1;
      min-height: 40px;
      max-height: 120px;
      padding: 12px;
      border: 2px solid var(--pale-khaki);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      background: white;
    }
    
    .question-textarea:focus {
      outline: none;
      border-color: var(--primary-khaki);
      box-shadow: 0 0 0 2px var(--shadow-khaki);
    }
    
    .ask-btn {
      padding: 12px 20px;
      background: var(--primary-khaki);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .ask-btn:hover {
      background: var(--dark-khaki);
    }
    
    .ask-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ */
    .status-area {
      background: var(--cream-khaki);
      padding: 12px 16px;
      border-top: 1px solid var(--pale-khaki);
      font-size: 13px;
      color: var(--dark-khaki);
    }
    
    .status-item {
      display: inline-block;
      margin-right: 16px;
    }
    
    .status-value {
      font-weight: 600;
      color: var(--primary-khaki);
    }
    
    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .loading::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--pale-khaki);
      border-top: 2px solid var(--primary-khaki);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .file-panel {
        order: 1;
        max-height: 300px;
      }
      
      .chat-panel {
        order: 2;
        min-height: 500px;
      }
      
      .question-input {
        flex-direction: column;
        align-items: stretch;
      }
      
      .ask-btn {
        margin-top: 8px;
      }
    }
    
    /* ÊàêÂäü„Éª„Ç®„É©„ÉºË°®Á§∫ */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üî¨ „Éï„Ç°„Ç§„É´Ëß£Êûê„Éª„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ</h1>
    <p>ÁîªÂÉè„ÉªPDF„Éï„Ç°„Ç§„É´„ÇíGemini AI„ÅßË©≥Á¥∞Ëß£Êûê„Åó„ÄÅË≥™ÂïèÂøúÁ≠î„Åß„Åç„Åæ„Åô</p>
    
    <div class="navigation">
      <a href="javascript:goToSearchPage()" class="nav-btn">üîç Ê§úÁ¥¢Ê©üËÉΩ</a>
      <a href="javascript:void(0)" class="nav-btn active">üî¨ „Éï„Ç°„Ç§„É´Ëß£Êûê</a>
    </div>
  </div>

  <div class="main-container">
    <!-- „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Éë„Éç„É´ -->
    <div class="file-panel">
      <div class="panel-header">
        üìÅ „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„ÉªÁÆ°ÁêÜ
      </div>
      
      <div class="file-content">
        <!-- Ê§úÁ¥¢Áµ±Âêà -->
        <div class="search-integration">
          <h4>üîç Ê§úÁ¥¢ÁµêÊûú„Åã„ÇâÈÅ∏Êäû</h4>
          <button class="search-btn" onclick="openSearchResults()">Ê§úÁ¥¢ÁµêÊûú„ÇíË°®Á§∫</button>
          <button class="search-btn" onclick="importFromUrl()">URL„Åã„ÇâÁõ¥Êé•„Ç§„É≥„Éù„Éº„Éà</button>
        </div>
        
        <!-- „Éï„Ç°„Ç§„É´ÈÅ∏Êäû -->
        <div class="file-selector" id="fileSelector">
          <div>
            <p>üìé „Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
            <p>„Åæ„Åü„ÅØ</p>
            <button class="file-selector-btn" onclick="document.getElementById('fileInput').click()">
              üìÅ „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
            </button>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf" onchange="handleFileSelect(event)">
          </div>
          <div style="margin-top: 12px; font-size: 12px; color: #666;">
            ÂØæÂøúÂΩ¢Âºè: JPEG, PNG, GIF, WebP, PDF<br>
            ÊúÄÂ§ß„Çµ„Ç§„Ç∫: 20MB<br>
            ÊúÄÂ§ßÂêåÊôÇ: 16„Éï„Ç°„Ç§„É´
          </div>
        </div>
        
        <!-- ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´ -->
        <div class="selected-files" id="selectedFiles">
          <h4>ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´</h4>
          <div id="fileList">
            <p style="color: #666; font-size: 14px;">„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- „ÉÅ„É£„ÉÉ„Éà„ÉªËß£Êûê„Éë„Éç„É´ -->
    <div class="chat-panel">
      <div class="panel-header">
        üí¨ AIËß£Êûê„ÉªË≥™ÂïèÂøúÁ≠î
      </div>
      
      <div class="chat-content">
        <div id="alertArea"></div>
        
        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-header">ü§ñ Gemini AI</div>
            <div class="message-content">
              „Åì„Çì„Å´„Å°„ÅØÔºÅ„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶Ëß£Êûê„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
              ÁîªÂÉè„ÇÑÂõ≥Èù¢„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇË≥™Âïè„Åó„Å¶„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ
            </div>
          </div>
        </div>
      </div>
      
      <div class="question-input-area">
        <div class="question-examples">
          <h4>üí° Ë≥™Âïè‰æãÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÖ•ÂäõÔºâ</h4>
          <div class="example-questions">
            <span class="example-question" onclick="setQuestion('„Åì„ÅÆÂõ≥Èù¢„ÅÆÊ¶ÇË¶Å„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ')">Âõ≥Èù¢„ÅÆÊ¶ÇË¶Å</span>
            <span class="example-question" onclick="setQuestion('ÂØ∏Ê≥ï„ÇÑ‰ªïÊßò„ÅÆË©≥Á¥∞„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ')">ÂØ∏Ê≥ï„Éª‰ªïÊßò</span>
            <span class="example-question" onclick="setQuestion('„Éá„Ç∂„Ç§„É≥„ÅÆÁâπÂæ¥„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ')">„Éá„Ç∂„Ç§„É≥ÂàÜÊûê</span>
            <span class="example-question" onclick="setQuestion('ÂïèÈ°åÁÇπ„ÇÑÊîπÂñÑÊèêÊ°à„ÅØ„ÅÇ„Çä„Åæ„Åô„Åã')">ÊîπÂñÑÊèêÊ°à</span>
            <span class="example-question" onclick="setQuestion('È°û‰ºº„Åó„Åü„Éá„Ç∂„Ç§„É≥„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô')">„Éá„Ç∂„Ç§„É≥„Ç¢„Éâ„Éê„Ç§„Çπ</span>
            <span class="example-question" onclick="setQuestion('„Åì„ÅÆÂª∫Áâ©„ÅÆÁî®ÈÄî„ÇÑÊ©üËÉΩ„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ')">Áî®ÈÄî„ÉªÊ©üËÉΩ</span>
          </div>
        </div>
        
        <div class="question-input">
          <textarea 
            id="questionTextarea" 
            class="question-textarea" 
            placeholder="„Éï„Ç°„Ç§„É´„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
            onkeydown="handleQuestionKeyDown(event)"
            disabled
          ></textarea>
          <button id="askBtn" class="ask-btn" onclick="askQuestion()" disabled>
            ÈÄÅ‰ø°
          </button>
        </div>
      </div>
      
      <div class="status-area" id="statusArea">
        <span class="status-item">„Çπ„ÉÜ„Éº„Çø„Çπ: <span class="status-value" id="currentStatus">ÂæÖÊ©ü‰∏≠</span></span>
        <span class="status-item">ÈÅ∏Êäû„Éï„Ç°„Ç§„É´: <span class="status-value" id="fileCount">0</span>‰ª∂</span>
        <span class="status-item">Ë≥™ÂïèÊï∞: <span class="status-value" id="questionCount">0</span>‰ª∂</span>
      </div>
    </div>
  </div>

  <script>
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let currentAnalysisSession = null;
    let selectedFiles = [];
    let questionCounter = 0;
    let isProcessing = false;

    // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº
    window.addEventListener('error', function(e) {
      console.error('JavaScript „Ç®„É©„Éº:', e.error);
      console.error('„Ç®„É©„ÉºË©≥Á¥∞:', e.message, 'at', e.filename, ':', e.lineno);
    });

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
    window.addEventListener('load', function() {
      try {
        console.log('üî¨ „Éï„Ç°„Ç§„É´Ëß£Êûê„Éª„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ Ëµ∑Âãï');
        setupFileDropArea();
        checkForImportedFile();
        updateStatus();
        
        // ÂàùÊúüË°®Á§∫Á¢∫Ë™ç
        console.log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫Ü');
      } catch (error) {
        console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        document.body.innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <h1 style="color: red;">‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº</h1>
            <p>„Ç®„É©„Éº: ${error.message}</p>
            <p>„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
          </div>
        `;
      }
    });

    // Ê§úÁ¥¢„Éö„Éº„Ç∏„Å∏ÁßªÂãï
    function goToSearchPage() {
      const currentUrl = window.location.origin + window.location.pathname;
      const searchUrl = currentUrl + '?page=search';
      window.location.href = searchUrl;
    }

    // „Éï„Ç°„Ç§„É´„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÅÆË®≠ÂÆö
    function setupFileDropArea() {
      const fileSelector = document.getElementById('fileSelector');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileSelector.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        fileSelector.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        fileSelector.addEventListener(eventName, unhighlight, false);
      });
      
      fileSelector.addEventListener('drop', handleDrop, false);
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function highlight(e) {
      document.getElementById('fileSelector').classList.add('dragover');
    }

    function unhighlight(e) {
      document.getElementById('fileSelector').classList.remove('dragover');
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
    function handleFileSelect(event) {
      const files = event.target.files;
      handleFiles(files);
    }

    function handleFiles(files) {
      const limits = {
        maxFiles: 16,
        maxFileSize: 20 * 1024 * 1024,
        supportedTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf']
      };

      Array.from(files).forEach(file => {
        // Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
        if (selectedFiles.length >= limits.maxFiles) {
          showAlert('error', `ÊúÄÂ§ß${limits.maxFiles}„Éï„Ç°„Ç§„É´„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô`);
          return;
        }

        if (file.size > limits.maxFileSize) {
          showAlert('error', `„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô: ${file.name} (ÊúÄÂ§ß20MB)`);
          return;
        }

        if (!limits.supportedTypes.includes(file.type)) {
          showAlert('error', `„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô: ${file.name}`);
          return;
        }

        // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
        if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
          showAlert('warning', `Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô: ${file.name}`);
          return;
        }

        // „Éï„Ç°„Ç§„É´ËøΩÂä†
        const fileInfo = {
          file: file,
          name: file.name,
          size: file.size,
          type: file.type,
          id: generateFileId(),
          status: 'selected'
        };

        selectedFiles.push(fileInfo);
      });

      updateFileList();
      updateStatus();
    }

    // „Éï„Ç°„Ç§„É´„É™„Çπ„ÉàË°®Á§∫Êõ¥Êñ∞
    function updateFileList() {
      const fileList = document.getElementById('fileList');
      
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '<p style="color: #666; font-size: 14px;">„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
        return;
      }

      const html = selectedFiles.map((fileInfo, index) => `
        <div class="file-item" data-file-id="${fileInfo.id}">
          <div class="file-info">
            <div class="file-name">üìÑ ${fileInfo.name}</div>
            <div class="file-meta">
              ${formatFileSize(fileInfo.size)} ‚Ä¢ ${fileInfo.type} ‚Ä¢ ${fileInfo.status}
            </div>
          </div>
          <div class="file-actions">
            <button class="file-action-btn btn-analyze" onclick="analyzeFile(${index})" 
                    ${fileInfo.status === 'analyzing' ? 'disabled' : ''}>
              ${fileInfo.status === 'analyzing' ? 'Ëß£Êûê‰∏≠...' : 'Ëß£Êûê'}
            </button>
            <button class="file-action-btn btn-remove" onclick="removeFile(${index})">
              ÂâäÈô§
            </button>
          </div>
        </div>
      `).join('');

      fileList.innerHTML = html;
    }

    // „Éï„Ç°„Ç§„É´Ëß£ÊûêÈñãÂßã
    async function analyzeFile(fileIndex) {
      if (isProcessing) {
        showAlert('warning', 'Âá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      const fileInfo = selectedFiles[fileIndex];
      if (!fileInfo) return;

      try {
        isProcessing = true;
        fileInfo.status = 'analyzing';
        updateFileList();
        updateStatus('„Éï„Ç°„Ç§„É´Ëß£Êûê‰∏≠...');

        // Google Drive„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅÆÂá¶ÁêÜ
        // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´„Çí‰∏ÄÊôÇÁöÑ„Å´Google Drive„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Åã„ÄÅ
        // Âà•„ÅÆÊñπÊ≥ï„ÅßGemini File API„Å´Ê∏°„ÅôÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô
        
        showAlert('warning', '„Éï„Ç°„Ç§„É´Ëß£ÊûêÊ©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô„ÄÇGoogle DriveÁµåÁî±„Åß„ÅÆËß£Êûê„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
        
        // ÈñãÁô∫Áî®„ÅÆÁñë‰ººÂá¶ÁêÜ
        setTimeout(() => {
          fileInfo.status = 'ready';
          updateFileList();
          updateStatus();
          isProcessing = false;
          
          // „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ„ÇíÊúâÂäπÂåñ
          enableChatInterface();
          
          addMessage('assistant', `„Éï„Ç°„Ç§„É´„Äå${fileInfo.name}„Äç„ÅÆËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ‰Ωï„ÅãË≥™Âïè„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü`);
        }, 2000);

      } catch (error) {
        console.error('„Éï„Ç°„Ç§„É´Ëß£Êûê„Ç®„É©„Éº:', error);
        showAlert('error', `Ëß£Êûê„Ç®„É©„Éº: ${error.message}`);
        fileInfo.status = 'error';
        updateFileList();
        isProcessing = false;
      }
    }

    // „Éï„Ç°„Ç§„É´ÂâäÈô§
    function removeFile(fileIndex) {
      selectedFiles.splice(fileIndex, 1);
      updateFileList();
      updateStatus();
      
      if (selectedFiles.length === 0) {
        disableChatInterface();
        clearChat();
      }
    }

    // „ÉÅ„É£„ÉÉ„Éà„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÂà∂Âæ°
    function enableChatInterface() {
      document.getElementById('questionTextarea').disabled = false;
      document.getElementById('askBtn').disabled = false;
    }

    function disableChatInterface() {
      document.getElementById('questionTextarea').disabled = true;
      document.getElementById('askBtn').disabled = true;
    }

    // Ë≥™ÂïèÂá¶ÁêÜ
    async function askQuestion() {
      const textarea = document.getElementById('questionTextarea');
      const question = textarea.value.trim();
      
      if (!question) {
        showAlert('warning', 'Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      if (isProcessing) {
        showAlert('warning', 'Âá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      const readyFiles = selectedFiles.filter(f => f.status === 'ready');
      if (readyFiles.length === 0) {
        showAlert('warning', 'Ëß£ÊûêÊ∏à„Åø„ÅÆ„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }

      try {
        isProcessing = true;
        textarea.value = '';
        document.getElementById('askBtn').disabled = true;
        
        // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
        addMessage('user', question);
        
        // „ÄåÂõûÁ≠îÁîüÊàê‰∏≠...„Äç„É°„ÉÉ„Çª„Éº„Ç∏
        const loadingMessageId = addMessage('assistant', 'ÂõûÁ≠î„ÇíÁîüÊàê‰∏≠...', true);
        
        updateStatus('Ë≥™ÂïèÂá¶ÁêÜ‰∏≠...');
        
        // ÂÆüÈöõ„ÅÆGemini APIÂëº„Å≥Âá∫„Åó
        google.script.run
          .withSuccessHandler(function(response) {
            removeMessage(loadingMessageId);
            
            if (response.success) {
              addMessage('assistant', response.response);
              questionCounter++;
            } else {
              addMessage('assistant', `‚ùå „Ç®„É©„Éº: ${response.error}`);
            }
            
            updateStatus();
            isProcessing = false;
            document.getElementById('askBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            removeMessage(loadingMessageId);
            addMessage('assistant', `‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: ${error.message || error}`);
            
            updateStatus();
            isProcessing = false;
            document.getElementById('askBtn').disabled = false;
          })
          .processAnalysisQuestion(currentAnalysisSession, question);

      } catch (error) {
        console.error('Ë≥™ÂïèÂá¶ÁêÜ„Ç®„É©„Éº:', error);
        showAlert('error', `Ë≥™ÂïèÂá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`);
        isProcessing = false;
        document.getElementById('askBtn').disabled = false;
      }
    }

    // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
    function addMessage(type, content, isLoading = false) {
      const chatMessages = document.getElementById('chatMessages');
      const messageId = 'msg_' + Date.now();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.id = messageId;
      
      const icon = type === 'user' ? 'üë§' : 'ü§ñ';
      const sender = type === 'user' ? '„ÅÇ„Å™„Åü' : 'Gemini AI';
      
      messageDiv.innerHTML = `
        <div class="message-header">${icon} ${sender}</div>
        <div class="message-content">${content}</div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageId;
    }

    // „É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§
    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // „ÉÅ„É£„ÉÉ„Éà„ÇØ„É™„Ç¢
    function clearChat() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `
        <div class="message assistant">
          <div class="message-header">ü§ñ Gemini AI</div>
          <div class="message-content">
            „Åì„Çì„Å´„Å°„ÅØÔºÅ„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶Ëß£Êûê„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
            ÁîªÂÉè„ÇÑÂõ≥Èù¢„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇË≥™Âïè„Åó„Å¶„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ
          </div>
        </div>
      `;
      questionCounter = 0;
    }

    // Ë≥™Âïè‰æãË®≠ÂÆö
    function setQuestion(question) {
      document.getElementById('questionTextarea').value = question;
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    function handleQuestionKeyDown(event) {
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault();
        askQuestion();
      }
    }

    // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
    function updateStatus(status = 'ÂæÖÊ©ü‰∏≠') {
      document.getElementById('currentStatus').textContent = status;
      document.getElementById('fileCount').textContent = selectedFiles.length;
      document.getElementById('questionCount').textContent = questionCounter;
    }

    // „Ç¢„É©„Éº„ÉàË°®Á§∫
    function showAlert(type, message) {
      const alertArea = document.getElementById('alertArea');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${type}`;
      alertDiv.textContent = message;
      
      alertArea.appendChild(alertDiv);
      
      // 5ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Ê§úÁ¥¢ÁµêÊûúÈÄ£Êê∫ÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
    function openSearchResults() {
      // Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÊ§úÁ¥¢ÁîªÈù¢„ÇíÈñã„Åè
      window.open('index.html', '_blank');
    }

    function importFromUrl() {
      const url = prompt('Google Drive„Éï„Ç°„Ç§„É´„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
      if (url) {
        showAlert('warning', 'URL „Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô');
      }
    }

    // Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„ÅÆ„Éï„Ç°„Ç§„É´„Ç§„É≥„Éù„Éº„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    function checkForImportedFile() {
      try {
        const importedFileData = sessionStorage.getItem('analysisFile');
        if (importedFileData) {
          const fileInfo = JSON.parse(importedFileData);
          console.log('üîó Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„Éï„Ç°„Ç§„É´„Ç§„É≥„Éù„Éº„Éà:', fileInfo);
          
          // „Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
          sessionStorage.removeItem('analysisFile');
          
          // „Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ
          importFileFromSearch(fileInfo);
        }
      } catch (error) {
        console.error('„Éï„Ç°„Ç§„É´„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
      }
    }

    // Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„ÅÆ„Éï„Ç°„Ç§„É´„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
    function importFileFromSearch(fileInfo) {
      showAlert('success', `Ê§úÁ¥¢ÁµêÊûú„Åã„Çâ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü: ${fileInfo.fileName}`);
      
      // Google Drive „Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Êâ±„ÅÜÁñë‰ºº„Éï„Ç°„Ç§„É´ÊÉÖÂ†±„Çí‰ΩúÊàê
      const virtualFileInfo = {
        name: fileInfo.fileName,
        size: 0, // ÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÅØ‰∏çÊòé
        type: 'application/pdf', // ‰ªÆ„ÅÆ MIME „Çø„Ç§„Éó
        id: generateFileId(),
        status: 'imported',
        driveFileId: fileInfo.fileId,
        source: 'search'
      };
      
      selectedFiles.push(virtualFileInfo);
      updateFileList();
      updateStatus();
      
      // Ëá™ÂãïËß£Êûê„ÇíÊèêÊ°à
      setTimeout(() => {
        if (confirm(`„Éï„Ç°„Ç§„É´„Äå${fileInfo.fileName}„Äç„ÇíËß£Êûê„Åó„Åæ„Åô„ÅãÔºü`)) {
          analyzeImportedFile(selectedFiles.length - 1);
        }
      }, 1000);
    }

    // „Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê
    async function analyzeImportedFile(fileIndex) {
      if (isProcessing) {
        showAlert('warning', 'Âá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      const fileInfo = selectedFiles[fileIndex];
      if (!fileInfo || !fileInfo.driveFileId) {
        showAlert('error', '„Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÅåÁÑ°Âäπ„Åß„Åô');
        return;
      }

      try {
        isProcessing = true;
        fileInfo.status = 'analyzing';
        updateFileList();
        updateStatus('Google Drive „Éï„Ç°„Ç§„É´Ëß£Êûê‰∏≠...');

        console.log(`üì§ Google Drive „Éï„Ç°„Ç§„É´Ëß£ÊûêÈñãÂßã: ${fileInfo.driveFileId}`);

        // Google Apps Script „ÅÆËß£ÊûêÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
        const result = await google.script.run
          .withSuccessHandler(function(analysisResult) {
            handleAnalysisSuccess(fileIndex, analysisResult);
          })
          .withFailureHandler(function(error) {
            handleAnalysisError(fileIndex, error);
          })
          .createAnalysisSession([fileInfo.driveFileId]);

      } catch (error) {
        console.error('„Éï„Ç°„Ç§„É´Ëß£Êûê„Ç®„É©„Éº:', error);
        handleAnalysisError(fileIndex, error);
      }
    }

    // Ëß£ÊûêÊàêÂäüÊôÇ„ÅÆÂá¶ÁêÜ
    function handleAnalysisSuccess(fileIndex, analysisResult) {
      console.log('‚úÖ „Éï„Ç°„Ç§„É´Ëß£ÊûêÊàêÂäü:', analysisResult);
      
      const fileInfo = selectedFiles[fileIndex];
      fileInfo.status = 'ready';
      fileInfo.analysisSession = analysisResult;
      
      updateFileList();
      updateStatus();
      isProcessing = false;
      
      // „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ„ÇíÊúâÂäπÂåñ
      enableChatInterface();
      
      addMessage('assistant', `„Éï„Ç°„Ç§„É´„Äå${fileInfo.name}„Äç„ÅÆËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÁîªÂÉè„ÅÆÂÜÖÂÆπ„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇË≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`);
      
      showAlert('success', 'Ëß£ÊûêÂÆå‰∫ÜÔºÅË≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }

    // Ëß£Êûê„Ç®„É©„ÉºÊôÇ„ÅÆÂá¶ÁêÜ
    function handleAnalysisError(fileIndex, error) {
      console.error('‚ùå „Éï„Ç°„Ç§„É´Ëß£Êûê„Ç®„É©„Éº:', error);
      
      const fileInfo = selectedFiles[fileIndex];
      fileInfo.status = 'error';
      
      updateFileList();
      updateStatus();
      isProcessing = false;
      
      showAlert('error', `Ëß£Êûê„Ç®„É©„Éº: ${error.message || error}`);
    }

    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
    function generateFileId() {
      return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function generateMockResponse(question) {
      const responses = {
        'Ê¶ÇË¶Å': '„Åì„ÅÆÂõ≥Èù¢„ÅØ‰ΩèÂÆÖ„ÅÆÂπ≥Èù¢Âõ≥„ÅÆ„Çà„ÅÜ„Åß„Åô„ÄÇ„É™„Éì„É≥„Ç∞„ÄÅ„Ç≠„ÉÉ„ÉÅ„É≥„ÄÅÂØùÂÆ§„ÅåÈÖçÁΩÆ„Åï„Çå„Å¶„Åä„Çä„ÄÅÂãïÁ∑ö„ÅåÂäπÁéáÁöÑ„Å´Ë®≠Ë®à„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
        'ÂØ∏Ê≥ï': '‰∏ªË¶Å„Å™ÂØ∏Ê≥ï„Å®„Åó„Å¶„ÄÅ„É™„Éì„É≥„Ç∞„ÅåÁ¥Ñ15Áï≥„ÄÅ„Ç≠„ÉÉ„ÉÅ„É≥„ÅåÂØæÈù¢Âºè„ÅßÁ¥Ñ6Áï≥„ÅÆÂ∫É„Åï„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
        '„Éá„Ç∂„Ç§„É≥': '„É¢„ÉÄ„É≥„ÅßÊ©üËÉΩÁöÑ„Å™„Éá„Ç∂„Ç§„É≥„ÅåÁâπÂæ¥ÁöÑ„Åß„Åô„ÄÇ„Ç™„Éº„Éó„É≥„Å™ÈñìÂèñ„Çä„ÅßÈñãÊîæÊÑü„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ',
        'ÊîπÂñÑ': 'ÂèéÁ¥ç„Çπ„Éö„Éº„Çπ„ÇíÂ¢ó„ÇÑ„Åô„Åì„Å®„Åß„ÄÅ„Çà„ÇäÂÆüÁî®ÁöÑ„Å´„Å™„Çã„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ',
        '„Ç¢„Éâ„Éê„Ç§„Çπ': '„Åì„ÅÆÁ©∫Èñì„É¨„Ç§„Ç¢„Ç¶„Éà„ÅØÂÆ∂ÊóèÂêë„Åë„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„Å¶„Åä„Çä„ÄÅ„Éê„É©„É≥„Çπ„ÅÆËâØ„ÅÑË®≠Ë®à„Åß„Åô„ÄÇ'
      };
      
      for (const [key, response] of Object.entries(responses)) {
        if (question.includes(key)) {
          return response;
        }
      }
      
      return `„Äå${question}„Äç„Å´„Å§„ÅÑ„Å¶Ë©≥Á¥∞„Å´ÂàÜÊûê„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÁîªÂÉè/Âõ≥Èù¢„Åã„ÇâË™≠„ÅøÂèñ„Çå„ÇãÁâπÂæ¥„ÇÑË¶ÅÁ¥†„Å´„Å§„ÅÑ„Å¶„ÄÅÂª∫ÁØâ„Éª„Éá„Ç∂„Ç§„É≥„ÅÆÂ∞ÇÈñÄÁöÑË¶≥ÁÇπ„Åã„Çâ„ÅäÁ≠î„Åà„Åó„Åæ„Åô„ÄÇ`;
    }
  </script>
</body>
</html>